#[test]
fn test_resetting_glean_clears_internal_metrics() {
    let _lock = Mutex::new(()).lock().unwrap();

    let dir = tempfile::tempdir().unwrap();
    let tmpname = dir.path().display().to_string();

    // Initialize Glean with some metrics
    test_reset_glean(
        Configuration {
            data_path: tmpname.clone(),
            application_id: GLOBAL_APPLICATION_ID.into(),
            upload_enabled: true,
            max_events: None,
            delay_ping_lifetime_io: false,
            channel: None,
            server_endpoint: Some("invalid-test-host".into()),
            uploader: None,
        },
        ClientInfoMetrics::unknown(),
        true,
    );

    // Set some values
    core_metrics::internal_metrics::app_build.set_sync(&Glean::new(), "test-build");
    core_metrics::internal_metrics::app_display_version.set_sync(&Glean::new(), "test-version");

    // Reset Glean
    test_reset_glean(
        Configuration {
            data_path: tmpname,
            application_id: GLOBAL_APPLICATION_ID.into(),
            upload_enabled: true,
            max_events: None,
            delay_ping_lifetime_io: false,
            channel: None,
            server_endpoint: Some("invalid-test-host".into()),
            uploader: None,
        },
        ClientInfoMetrics::unknown(),
        true,
    );

    // Verify metrics are cleared
    assert!(core_metrics::internal_metrics::app_build.test_get_value(None).is_none());
    assert!(core_metrics::internal_metrics::app_display_version.test_get_value(None).is_none());
}