#[test]
fn test_pending_pings_quota_is_enforced() {
  let (mut glean, dir) = new_glean(None);
  let ping_type = PingType::new("test", true, true, vec![]);
  glean.register_ping_type(&ping_type);

  let n = 300;
  for _ in 0..n {
    glean.submit_ping(&ping_type, None).unwrap();
  }

  let mut upload_manager = PingUploadManager::no_policy(dir.path());
  upload_manager.policy.set_max_pending_pings_count(Some(250));

  let actual_count = upload_manager.upload_metrics.pending_pings.test_get_value(&glean, "metrics").unwrap();
  assert_eq!(n as i32, actual_count);

  let deleted_count = upload_manager.upload_metrics.deleted_pings_after_quota_hit.test_get_value(&glean, "metrics").unwrap();
  assert_eq!((n - 250) as i32, deleted_count);
}