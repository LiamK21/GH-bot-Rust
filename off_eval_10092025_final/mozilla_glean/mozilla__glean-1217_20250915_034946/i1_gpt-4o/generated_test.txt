#[test]
fn test_log_message_reduction_on_startup() {
    let (mut glean, dir) = new_glean(None);

    // Register a ping for testing
    let ping_type = PingType::new("test", true, /* send_if_empty */ true, vec![]);
    glean.register_ping_type(&ping_type);

    // The number of pings we fill the pending pings directory with.
    let n = 10;

    // Submit the ping multiple times
    for _ in 0..n {
        glean.submit_ping(&ping_type, None).unwrap();
    }

    // Create a new upload manager pointing to the same data_path as the glean instance.
    let mut upload_manager = PingUploadManager::no_policy(dir.path());

    // Set a limit on the number of pending pings
    upload_manager.policy.set_max_pending_pings_count(Some(5));

    // Get a task once
    // This should trigger the log message reduction
    for _ in 0..5 {
        match upload_manager.get_upload_task(&glean, false) {
            PingUploadTask::Upload(_) => (),
            _ => panic!("Expected upload manager to return the next request!"),
        }
    }

    // Verify that no other requests were returned,
    // they should all have been deleted because pending pings quota was hit.
    assert_eq!(
        upload_manager.get_upload_task(&glean, false),
        PingUploadTask::Done
    );
}