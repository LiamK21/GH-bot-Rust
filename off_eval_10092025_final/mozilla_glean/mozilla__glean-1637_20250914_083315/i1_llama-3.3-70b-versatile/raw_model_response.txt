<Filename> glean-core/src/scheduler.rs </Filename>
<imports> 
use super::start_scheduler;
use std::sync::Condvar;
use std::sync::Arc;
use std::sync::Mutex;
use std::thread;
use std::time::Duration;
use chrono::{DateTime, FixedOffset};
use glean_core::scheduler::When;
use glean_core::scheduler::MetricsPingSubmitter;
</imports>
<Rust>
#[test]
fn test_start_scheduler_respects_timed_out_condition() {
  let submitter = MockMetricsPingSubmitter {};
  let now = DateTime::from NTZ_1970_01_01_00_00;
  let when = When::Reschedule;
  let cancelled = Arc::new(Mutex::new(false));
  let condvar = Arc::new(Condvar::new());
  let handle = thread::spawn(move || {
    start_scheduler(&submitter, now, when, cancelled.clone(), condvar.clone());
  });
  thread::sleep(Duration::from_millis(10));
  *cancelled.lock().unwrap() = true;
  condvar.notify_one();
  handle.join().unwrap();
  assert!(!submitter.submitted);
}

struct MockMetricsPingSubmitter {}

impl MetricsPingSubmitter for MockMetricsPingSubmitter {
  fn submit_metrics_ping(&self, _glean: &(), _reason: Option<()>, _now: DateTime<FixedOffset>) {
    self.submitted = true;
  }
}

impl MockMetricsPingSubmitter {
  fn new() -> Self {
    MockMetricsPingSubmitter { submitted: false }
  }
}

impl MockMetricsPingSubmitter {
  pub submitted: bool;
}
</Rust>