#[test]
fn test_scheduler_lock_order_inversion() {
    struct MockSubmitter;
    impl MetricsPingSubmitter for MockSubmitter {
        fn submit_metrics_ping(&self, _glean: &Glean, _reason: Option<&str>, _now: DateTime<FixedOffset>) {}
    }

    let submitter = MockSubmitter;
    let now = Utc::now().with_timezone(&FixedOffset::east(0));
    let when = When::Reschedule;
    let cancelled = Arc::new((Mutex::new(false), Condvar::new()));
    let cancelled_clone = Arc::clone(&cancelled);

    let handle = thread::spawn(move || {
        start_scheduler(submitter, now, when);
    });

    thread::sleep(Duration::from_millis(100));
    {
        let (lock, cvar) = &*cancelled_clone;
        let mut cancelled = lock.lock().unwrap();
        *cancelled = true;
        cvar.notify_one();
    }

    handle.join().unwrap();
    let (lock, _) = &*cancelled;
    let cancelled = lock.lock().unwrap();
    assert!(*cancelled);
}