#[test]
fn test_first_run_sends_overdue_ping_and_sets_last_sent_build() {
    let (mut glean, _t) = new_glean(None);

    glean.app_build = "a build".into();
    let lsb_metric = get_last_sent_build_metric();
    assert_eq!(None, lsb_metric.get_value(&glean, Some(INTERNAL_STORAGE)));

    let fake_now = FixedOffset::east(0)
        .ymd(2022, 11, 15)
        .and_hms(SCHEDULED_HOUR, 0, 1);

    let (submitter, submitter_count, scheduler, scheduler_count) = new_proxies(
        |_, reason| assert_eq!(reason, Some("overdue")),
        |_, when| assert_eq!(when, When::Reschedule),
    );

    schedule_internal(&glean, submitter, scheduler, fake_now);
    assert_eq!(1, submitter_count.swap(0, Ordering::Relaxed));
    assert_eq!(1, scheduler_count.swap(0, Ordering::Relaxed));

    assert_eq!(
        Some(glean.app_build.to_string()),
        lsb_metric.get_value(&glean, Some(INTERNAL_STORAGE))
    );
}