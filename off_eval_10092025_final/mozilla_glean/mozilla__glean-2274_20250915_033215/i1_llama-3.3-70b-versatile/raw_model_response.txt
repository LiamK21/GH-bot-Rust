<Filename> glean-core/src/scheduler.rs </Filename>
<imports> 
use super::schedule_internal;
use glean::Glean;
use glean::metrics::ping::MetricsPingSubmitter;
use glean::metrics::scheduler::MetricsPingScheduler;
use chrono::{DateTime, FixedOffset};
use std::sync::atomic::{AtomicUsize, Ordering};
</imports>
<Rust>
#[test]
fn test_schedule_internal_sends_upgrade_ping() {
  let glean = &Glean::new();
  let submitter_count = AtomicUsize::new(0);
  let scheduler_count = AtomicUsize::new(0);
  let submitter = MockSubmitter { count: submitter_count };
  let scheduler = MockScheduler { count: scheduler_count };
  let now = FixedOffset::east(0).ymd(2022, 11, 15).and_hms(12, 0, 1);
  schedule_internal(glean, &submitter, &scheduler, now);
  assert_eq!(1, submitter_count.load(Ordering::Relaxed));
  assert_eq!(1, scheduler_count.load(Ordering::Relaxed));
}

struct MockSubmitter {
  count: AtomicUsize,
}

impl MetricsPingSubmitter for MockSubmitter {
  fn submit(&self, _ping: &str, reason: Option<&str>) {
    self.count.fetch_add(1, Ordering::Relaxed);
    assert_eq!(reason, Some("upgrade"));
  }
}

struct MockScheduler {
  count: AtomicUsize,
}

impl MetricsPingScheduler for MockScheduler {
  fn start_scheduler(&self, _submitter: &dyn MetricsPingSubmitter, _now: DateTime<FixedOffset>, _when: glean::metrics::scheduler::When) {
    self.count.fetch_add(1, Ordering::Relaxed);
  }
}
</Rust>