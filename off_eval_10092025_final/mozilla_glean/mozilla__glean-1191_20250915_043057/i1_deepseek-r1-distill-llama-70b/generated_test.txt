#[test]
fn test_async_ping_directories_scanning_completes() {
    let (glean, dir) = new_glean(None);

    // Create an upload manager with async scanning
    let mut upload_manager =
        PingUploadManager::no_policy(dir.path(), /* sync_scan */ false);

    // Enqueue a test ping
    let ping_type = PingType::new("test", true, /* send_if_empty */ true, vec![]);
    glean.register_ping_type(&ping_type).unwrap();
    glean.submit_ping(&ping_type, None).unwrap();

    // Wait for upload task to complete, should not hang indefinitely
    let start = std::time::Instant::now();
    while upload_manager.get_upload_task(&glean, false) == PingUploadTask::Wait {
        thread::sleep(Duration::from_millis(10));
        assert!(start.elapsed().as_secs() < 10, "Upload task did not complete in a reasonable time");
    }

    assert_eq!(upload_manager.get_upload_task(&glean, false), PingUploadTask::Done);
}