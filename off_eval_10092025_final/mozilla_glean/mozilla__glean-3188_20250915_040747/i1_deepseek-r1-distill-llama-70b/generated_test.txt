#[test]
fn test_uploader_capabilities_included_in_ping() {
    let mut ping = Ping::new("test_ping".into());
    ping.uploader_capabilities = vec!["test_cap".to_string()];

    let ping_data = ping.build().unwrap();

    let expected_key = "glean.ping.uploader_capabilities";
    let actual: Value = serde_json::from_str(&ping_data).unwrap();

    let metrics = actual["metrics"]
        .as_object()
        .and_then(|m| m.get("string_list"))
        .and_then(|sl| sl.as_object())
        .and_then(|slo| slo.get(expected_key));

    assert!(
        metrics.is_some(),
        "Uploader capabilities should be included in the ping metrics"
    );

    // Test with empty capabilities
    let mut ping_empty = Ping::new("test_ping_empty".into());
    ping_empty.uploader_capabilities = vec![];

    let ping_empty_data = ping_empty.build().unwrap();
    let actual_empty: Value = serde_json::from_str(&ping_empty_data).unwrap();

    let metrics_empty = actual_empty["metrics"]
        .as_object()
        .and_then(|m| m.get("string_list"))
        .and_then(|sl| sl.as_object())
        .and_then(|slo| slo.get(expected_key));

    assert!(
        metrics_empty.is_none(),
        "Uploader capabilities should not be included when empty"
    );
}