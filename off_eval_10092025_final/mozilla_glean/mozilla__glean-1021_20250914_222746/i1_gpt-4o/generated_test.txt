#[test]
fn test_processes_correctly_client_error_upload_response() {
    let (mut glean, dir) = new_glean(None);

    // Wait for processing of pending pings directory to finish.
    while glean.get_upload_task(false) == PingUploadTask::Wait {
        std::thread::sleep(Duration::from_millis(10));
    }

    // Register a ping for testing
    let ping_type = crate::metrics::PingType::new("test", true, /* send_if_empty */ true, vec![]);
    glean.register_ping_type(&ping_type);

    // Submit a ping
    let doc_id = uuid::Uuid::new_v4().to_string();
    let path = format!("/submit/app_id/test-ping/1/{}", doc_id);
    glean.enqueue_ping(&doc_id, &path, json!({}), None);

    // Simulate a client error response
    glean.process_ping_upload_response(&doc_id, UploadResult::HttpStatus(400), None);

    // Verify that the ping is re-enqueued
    match glean.get_upload_task(false) {
        PingUploadTask::Upload(req) => assert_eq!(req.document_id, doc_id),
        _ => panic!("Expected upload manager to return the next request!"),
    }
}