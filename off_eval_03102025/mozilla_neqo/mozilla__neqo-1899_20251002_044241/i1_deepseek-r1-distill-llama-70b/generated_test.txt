#[test]
fn test_datagram_send_with_reference() {
    let addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
    let mut sender = Socket::bind(&addr).unwrap();
    let mut receiver = Socket::bind(&addr).unwrap();

    let data = b"test_data";
    let mut datagram = Datagram {
        src: addr,
        dst: addr,
        tos: IpTos::from(0),
        ttl: None,
        d: Vec::from(data),
        segment_size: None,
    };

    block_on(sender.writable())?;
    block_on(sender.send(&datagram))?;

    block_on(receiver.readable())?;
    let mut buf = [0; 1024];
    let (n, _) = block_on(receiver.recv_from(&mut buf))?;

    assert_eq!(&buf[..n], data);
}