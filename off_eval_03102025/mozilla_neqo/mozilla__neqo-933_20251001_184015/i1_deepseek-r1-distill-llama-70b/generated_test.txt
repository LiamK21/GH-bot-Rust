#[test]
fn test_persistent_congestion_ignores_pre_rtt_packets() {
    let mut cc = CongestionControl::default();
    let pto = Duration::from_millis(100);
    let now = now();

    // Packets sent before RTT sample
    let old_packet = SentPacket::new(
        PacketType::Short,
        0,
        now - Duration::from_millis(100),
        true,
        Rc::default(),
        1000,
    );

    // Packets sent after RTT sample
    let packet1 = SentPacket::new(
        PacketType::Short,
        1,
        now + Duration::from_millis(200),
        true,
        Rc::default(),
        1000,
    );
    let packet2 = SentPacket::new(
        PacketType::Short,
        2,
        now + Duration::from_millis(400),
        true,
        Rc::default(),
        1000,
    );

    let rtt_sample = now + Duration::from_millis(150);
    let lost_packets = vec![old_packet, packet1, packet2];

    // Before patch, this would incorrectly include old_packet
    // After patch, only packets after rtt_sample should be considered
    cc.detect_persistent_congestion(
        Some(rtt_sample),
        None,
        pto,
        &lost_packets,
    );

    // After patch, congestion window should be adjusted
    assert_eq!(cc.cwnd(), CWND_MIN);
}