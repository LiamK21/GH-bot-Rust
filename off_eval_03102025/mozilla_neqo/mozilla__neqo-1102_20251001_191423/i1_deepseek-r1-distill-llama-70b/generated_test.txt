#[test]
fn test_build_insufficient_space() {
    fixture_init();

    let mut builder = PacketBuilder::short(
        Encoder::with_capacity(100),
        true,
        &ConnectionId::from(SERVER_CID),
    );
    builder.pn(0, 1);
    // Pad, but not up to the full capacity. Leave enough space for the
    // AEAD expansion and some extra, but not for an entire long header.
    builder.set_limit(75);
    builder.pad().unwrap();
    let encoder = builder.build(&mut CryptoDxState::test_default()).unwrap();
    let encoder_copy = encoder.clone();

    let builder = PacketBuilder::long(
        encoder,
        PacketType::Initial,
        QuicVersion::default(),
        &ConnectionId::from(SERVER_CID),
        &ConnectionId::from(SERVER_CID),
    );
    assert_eq!(builder.remaining(), 0);
    assert_eq!(builder.abort(), encoder_copy);
}