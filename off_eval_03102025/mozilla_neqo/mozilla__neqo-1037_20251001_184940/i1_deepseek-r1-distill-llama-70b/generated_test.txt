#[test]
fn test_partial_request_handling() {
    let server = Http09Server::new(
        std::time::Instant::now(),
        &[],
        &[],
        AntiReplay::new(std::time::Instant::now(), std::time::Duration::from_secs(10), 7, 14).unwrap(),
        Rc::new(RefCell::new(RandomConnectionIdGenerator::new(10))),
    ).unwrap();

    let (sender, receiver) = mpsc::channel();

    let handle = thread::spawn(move || {
        let datagram = Datagram::new(
            "127.0.0.1:4433".parse().unwrap(),
            "127.0.0.1:4433".parse().unwrap(),
            b"GET / invalid-request\r\n".to_vec(),
        );
        let result = panic::catch_unwind(|| {
            server.process(Some(datagram), std::time::Instant::now());
        });
        sender.send(result.is_err()).unwrap();
    });

    handle.join().unwrap();
    assert!(receiver.recv().unwrap());
}