#[test]
fn test_send_ignore_emsgsize() {
    let sender = Socket::new(std::net::UdpSocket::bind("127.0.0.1:0").unwrap())?;
    let receiver = Socket::new(std::net::UdpSocket::bind("127.0.0.1:0").unwrap())?;
    let receiver_addr: std::net::SocketAddr = "127.0.0.1:0".parse().unwrap();

    // Send an oversized datagram and expect EMSIZE error to be ignored.
    let oversized_datagram = Datagram::new(
        sender.inner.local_addr().unwrap(),
        receiver.inner.local_addr().unwrap(),
    ).unwrap();
    // The send should fail with EMSIZE, but the socket remains usable.
    let result = sender.send(&oversized_datagram);
    assert!(result.is_err(), "Expected send to fail with EMSIZE");

    // Now send a normal datagram to ensure the socket is still usable.
    let normal_datagram = Datagram::new(
        sender.inner.local_addr().unwrap(),
        receiver.inner.local_addr().unwrap(),
    ).unwrap();
    sender.send(&normal_datagram).unwrap();

    // Block until "Hello World!" is received.
    receiver.inner.set_nonblocking(false).unwrap();
    let mut recv_buf = RecvBuf::new();
    let received_datagram = receiver.recv(receiver_addr, &mut recv_buf).unwrap();
    let message = received_datagram.next().unwrap().as_ref().unwrap();
    assert_eq!(message, b"Hello World!");
}