#[test]
fn test_data_blocked_sent_correctly() {
    let mut s = SendStream::new(1, 100, FlowMgr::new());
    let mut flow_mgr = FlowMgr::new();
    s.flow_mgr = flow_mgr.borrow_mut();

    // Initial send fills the credit
    s.send(b"abcd").unwrap();

    // Simulate sending multiple packets
    s.send(b"efgh").unwrap();
    s.send(b"ijkl").unwrap();

    // Verify that DATA_BLOCKED is sent only once when needed
    let mut frames = flow_mgr.borrow_mut().next().unwrap();
    match frames {
        Frame::DataBlocked { data_limit } => {
            assert_eq!(data_limit, 65536);
        },
        _ => panic!("Expected DATA_BLOCKED frame"),
    };

    // After the first send, no more DATA_BLOCKED should be sent
    assert!(flow_mgr.borrow_mut().next().is_none());
}