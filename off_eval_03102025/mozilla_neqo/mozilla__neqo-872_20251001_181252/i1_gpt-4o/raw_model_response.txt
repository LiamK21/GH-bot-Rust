<Filename>neqo-transport/src/send_stream.rs</Filename>

<imports>
use super::SendStream;
use crate::flow_mgr::FlowMgr;
use crate::frame::Frame;
use std::cell::RefCell;
use std::rc::Rc;
</imports>

<Rust>
#[test]
fn test_data_blocked_not_sent_aggressively() {
    let flow_mgr = Rc::new(RefCell::new(FlowMgr::default()));
    let mut s = SendStream::new(2, flow_mgr.clone());

    // Simulate sending data
    assert_eq!(s.send(b"abc").unwrap(), 2);
    assert_eq!(s.next_bytes(), Some((0, &b"ab"[..])));
    assert!(flow_mgr.borrow_mut().next().is_none());

    // Mark as sent to trigger potential DataBlocked
    s.mark_as_sent(0, 2, false);
    assert_eq!(
        flow_mgr.borrow_mut().next().unwrap(),
        Frame::StreamDataBlocked {
            stream_id: 2,
            limit: 2
        }
    );

    // Simulate sending more data
    assert_eq!(s.send(b"abcd").unwrap(), 3);
    assert_eq!(s.next_bytes(), Some((2, &b"abc"[..])));
    assert!(flow_mgr.borrow_mut().next().is_none());

    // Mark as sent to trigger potential DataBlocked
    s.mark_as_sent(2, 3, false);
    assert_eq!(
        flow_mgr.borrow_mut().next().unwrap(),
        Frame::DataBlocked { data_limit: 0x5 }
    );
}
</Rust>