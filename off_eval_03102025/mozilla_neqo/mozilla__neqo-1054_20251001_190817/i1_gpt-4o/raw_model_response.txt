<Filename>neqo-transport/src/connection/mod.rs</Filename>
<imports>
use super::Connection;
use crate::Error;
use crate::CloseError;
use crate::packet::PacketBuilder;
use std::time::Instant;
</imports>
<Rust>
#[test]
fn test_close_with_long_reason_string() {
    let mut builder = PacketBuilder::new();
    let mut connection = Connection::new();
    let long_reason = String::from_utf8([0x61; 2048].to_vec()).unwrap();
    let error_code = CloseError::Application(Error::HttpGeneralProtocol.code());
    let frame_type = 0x1;
    let now = Instant::now();

    connection.close(now, error_code, long_reason.clone());
    let reason_len = std::cmp::min(std::cmp::min(long_reason.len(), 256), builder.remaining() - 2);
    builder.encode_vvec(&long_reason[..reason_len]);

    assert_eq!(builder.remaining(), 0);
}
</Rust>