#[test]
fn test_send_stream_writable_event() {
    let mut client = default_client();
    let mut server = default_server();
    connect(&mut client, &mut server);

    let stream_id = client.stream_create(StreamType::UniDi).unwrap();
    assert_eq!(stream_id, 2);

    // Initial state: connection credit is limited
    assert_eq!(
        client.stream_avail_send_space(stream_id).unwrap(),
        LOCAL_MAX_DATA // 16383 in test config
    );

    // Send some data to block the stream
    assert_eq!(
        client
            .stream_send(stream_id, &[b'a'; RX_STREAM_DATA_WINDOW as usize])
            .unwrap(),
        LOCAL_MAX_DATA as usize
    );

    // Verify that no SendStreamWritable event is generated when credit is low
    let evts = client.events().collect::<Vec<_>>();
    assert_eq!(evts.len(), 0);

    // Increase connection max credit
    client.handle_max_data(100_000);

    // Verify that SendStreamWritable event is generated
    let evts = client.events().collect::<Vec<_>>();
    assert_eq!(evts.len(), 1);
    assert!(matches!(evts[0], ConnectionEvent::SendStreamWritable { .. }));
}