#[test]
fn test_maximum_wait_attempts_is_enforced() {
    let (glean, dir) = new_glean(None);

    let mut upload_manager = PingUploadManager::new(dir.path(), "Testing", true);

    let secs_per_interval = 5;
    let max_pings_per_interval = 1;
    upload_manager.set_rate_limiter(secs_per_interval, max_pings_per_interval);

    upload_manager.enqueue_ping(&glean, &Uuid::new_v4().to_string(), PATH, "", None);
    upload_manager.enqueue_ping(&glean, &Uuid::new_v4().to_string(), PATH, "", None);

    match upload_manager.get_upload_task(&glean, false) {
        PingUploadTask::Upload(_) => {}
        _ => panic!("Expected upload manager to return the next request!"),
    }

    for _ in 0..MAX_WAIT_ATTEMPTS {
        assert_eq!(
            upload_manager.get_upload_task(&glean, false),
            PingUploadTask::Wait
        );
    }

    assert_eq!(
        upload_manager.get_upload_task(&glean, false),
        PingUploadTask::Done
    );

    thread::sleep(Duration::from_secs(secs_per_interval));

    match upload_manager.get_upload_task(&glean, false) {
        PingUploadTask::Upload(_) => {}
        _ => panic!("Expected upload manager to return the next request!"),
    }

    assert_eq!(
        upload_manager.get_upload_task(&glean, false),
        PingUploadTask::Done
    );
}