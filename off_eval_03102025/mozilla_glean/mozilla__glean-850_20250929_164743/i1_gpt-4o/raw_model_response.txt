<Filename> glean-core/src/lib_unit_tests.rs </Filename>
<imports>
use super::*;
use crate::metrics::TimingDistributionMetric;
use crate::metrics::TimeUnit;
use std::collections::HashSet;
use std::iter::FromIterator;
</imports>
<Rust>
#[test]
fn test_timing_distribution_truncation_edge_case() {
    let dir = tempfile::tempdir().unwrap();
    let (glean, _) = new_glean(Some(dir));
    let max_sample_time = 1000 * 1000 * 1000 * 60 * 10;

    let mut dist = TimingDistributionMetric::new(
        CommonMetricData {
            name: "edge_case_metric".into(),
            category: "test".into(),
            send_in_pings: vec!["baseline".into()],
            ..Default::default()
        },
        TimeUnit::Nanosecond,
    );

    let edge_case_value = max_sample_time * 1_000_000 + 1;
    let timer_id = dist.set_start(0);
    dist.set_stop_and_accumulate(&glean, timer_id, edge_case_value);

    let hist = dist.test_get_value(&glean, "baseline").unwrap();
    let keys = HashSet::<u64>::from_iter(hist.values().keys().cloned());

    let expected_keys = HashSet::<u64>::from_iter(vec![1, 961_548, 599_512_966_122, 939]);
    assert_eq!(keys, expected_keys);
}
</Rust>