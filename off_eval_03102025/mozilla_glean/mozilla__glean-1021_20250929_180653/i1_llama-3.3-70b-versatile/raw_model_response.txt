<Filename> glean-core/src/upload/mod.rs </Filename>
<imports> 
use super::PingUploadManager;
use uuid::Uuid;
use std::thread;
use std::time::Duration;
use crate::tests::new_glean;
use crate::PingType;
</imports>
<Rust>
#[test]
fn test_duplicate_pings_are_not_enqueued() {
  let (mut glean, _) = new_glean(None);
  let ping_type = PingType::new("test", true, /* send_if_empty */ true, vec![]);
  glean.register_ping_type(&ping_type);
  let doc_id = Uuid::new_v4().to_string();
  let path = format!("/submit/app_id/test-ping/1/{}", doc_id);
  
  // Wait for processing of pending pings directory to finish.
  while glean.get_upload_task(false) == super::PingUploadTask::Wait {
    thread::sleep(Duration::from_millis(10));
  }

  // Try to enqueue a ping with the same doc_id twice
  glean.upload_manager.enqueue_ping(&doc_id, &path, serde_json::json!({}), None);
  glean.upload_manager.enqueue_ping(&doc_id, &path, serde_json::json!({}), None);

  // Get a task once
  match glean.upload_manager.get_upload_task(false) {
    super::PingUploadTask::Upload(_) => {}
    _ => panic!("Expected upload manager to return the next request!"),
  }

  // There should be no more queued tasks
  assert_eq!(glean.upload_manager.get_upload_task(false), super::PingUploadTask::Done);
}
</Rust>