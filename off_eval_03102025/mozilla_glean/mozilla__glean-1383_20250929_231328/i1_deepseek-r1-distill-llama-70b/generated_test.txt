#[test]
fn test_snapshot_metric_lifecycle() {
    let storage = Arc::new(Database::new());
    let mut snapshotter = Snapshotter::new();

    // Setup mock for storage.iter_store_from
    let mut mock_storage = mockall::Mock::<Database, _>::new();
    mock_storage
        .expect("iter_store_from")
        .with(alice::any_args)
        .returning(|_, _, _, _| Err("Not found".to_string()));

    let storage_manager = StorageManager::new(mock_storage);

    let metric_id = "test_metric";
    let store_name = "test_store";
    let lifetime = Lifetime::Application;

    // Test that only the specified lifetime is checked
    let result = storage_manager.snapshot_metric(
        &storage,
        store_name,
        metric_id,
        lifetime,
    );

    // Verify that the function no longer iterates all lifetimes
    // and only checks the specified one
    assert!(result.is_none());
}