<Filename> glean-core/src/database/mod.rs </Filename>
<imports> 
use super::rkv_new;
use super::migrate;
use std::path::Path;
use std::fs;
use rkv::Rkv;
use rkv::StoreError;
use rkv::migrator::Migrator;
use rkv::backend::Lmdb;
use rkv::backend::SafeMode;
</imports>
<Rust>
#[test]
fn test_safe_mode_migration() {
  let dir = std::path::Path::new("/tmp/test_rkv_migration");
  fs::create_dir_all(dir).unwrap();
  let datamdb = dir.join("data.mdb");
  let lockmdb = dir.join("lock.mdb");
  let safebin = dir.join("data.safe.bin");

  // Create an LMDB database
  let _rkv_db = rkv_new(dir).unwrap();
  assert!(datamdb.exists());
  assert!(lockmdb.exists());
  assert!(!safebin.exists());

  // Migrate the database to safe mode
  let rkv_db = rkv_new(dir).unwrap();
  migrate(dir, &rkv_db).unwrap();

  assert!(safebin.exists());
  assert!(!datamdb.exists());
  assert!(!lockmdb.exists());
}
</Rust>