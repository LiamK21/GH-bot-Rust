#[test]
fn test_async_ping_directories_scanning_completes() {
    let (mut glean, dir) = new_glean(None);

    // Create an upload manager with async scanning
    let mut upload_manager =
        PingUploadManager::no_policy(dir.path(), /* sync_scan */ false);

    // Register a test ping type
    let ping_type = PingType::new("test", true, /* send_if_empty */ true, vec![]);
    glean.register_ping_type(&ping_type);

    // Submit multiple pings
    for _ in 0..5 {
        glean.submit_ping(&ping_type, None).unwrap();
    }

    // Wait for all pings to be processed
    loop {
        match upload_manager.get_upload_task(&glean, false) {
            PingUploadTask::Upload(_) => {
                upload_manager.process_ping_upload_response(&glean, "test-doc-id", RecoverableFailure)
            }
            PingUploadTask::Done => break,
            PingUploadTask::Wait => {
                thread::sleep(Duration::from_millis(100));
            }
        }
    }

    // Verify that no more upload tasks are pending
    assert_eq!(upload_manager.get_upload_task(&glean, false), PingUploadTask::Done);
}