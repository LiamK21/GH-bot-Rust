#[test]
fn test_rate_limiter_enforces_limit() {
    let dir = tempfile::tempdir().unwrap();
    let mut upload_manager = PingUploadManager::new(dir.path(), false);

    // Set rate limit: 2 pings per second
    upload_manager.set_rate_limiter(1, 2);

    // Enqueue 3 pings
    for _ in 0..3 {
        upload_manager.enqueue_ping(DOCUMENT_ID, PATH, json!({}));
    }

    // First two should be processed immediately
    for _ in 0..2 {
        match upload_manager.get_upload_task(false) {
            PingUploadTask::Upload(_) => (),
            _ => panic!("Expected upload task"),
        }
    }

    // Third should be throttled
    match upload_manager.get_upload_task(false) {
        PingUploadTask::Wait => (),
        _ => panic!("Expected wait"),
    }

    // Wait for the interval to pass
    thread::sleep(Duration::from_secs(1));

    // Now the third ping should be processed
    match upload_manager.get_upload_task(false) {
        PingUploadTask::Upload(_) => (),
        _ => panic!("Expected upload task after interval"),
    }
}