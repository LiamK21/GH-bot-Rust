#[test]
fn test_memory_distribution_handle_no_storage() {
    struct TestLogger {
        called: Mutex<AtomicBool>,
    }

    impl Log for TestLogger {
        fn enabled(&self, _: &Metadata) -> bool {
            true
        }

        fn log(&self, record: &Record) {
            *self.called.lock().unwrap() = true;
            assert_eq!(record.level(), Level::Warn);
            assert!(record.message().contains("Couldn't get storage"));
        }

        fn flush(&self) {}
    }

    let logger = TestLogger {
        called: Mutex::new(AtomicBool::new(false)),
    };

    log::set_boxed_logger(Box::new(logger))?;

    let metric = MemoryDistributionMetric::new();
    let mock_glean = struct {
        storage_opt: || Option::None,
    };

    metric.accumulate(&mock_glean, 1024);

    assert!(logger.called.lock().unwrap().load());
}