<Filename> glean-core/src/lib_unit_tests.rs </Filename>
<imports> 
use super::Glean;
use super::MetricsEnabledConfig;
use super::StringMetric;
use super::new_glean;
</imports>
<Rust>
#[test]
fn test_merge_metric_configurations() {
  let (glean, _t) = new_glean(None);
  let metric = StringMetric::new(CommonMetricData {
      category: "category".to_string(),
      name: "string_metric".to_string(),
      send_in_pings: vec!["test".to_string()],
      ..Default::default()
  });
  let another_metric = StringMetric::new(CommonMetricData {
      category: "category".to_string(),
      name: "another_string_metric".to_string(),
      send_in_pings: vec!["test".to_string()],
      ..Default::default()
  });

  // 1. Set a new configuration where one metric is enabled
  let metrics_enabled_config = json!(
      {
          "category.string_metric": true,
      }
  )
  .to_string();
  glean.set_metrics_enabled_config(
      MetricsEnabledConfig::try_from(metrics_enabled_config).unwrap(),
  );

  // 2. Set a value for the first metric, which should succeed
  metric.set_sync(&glean, "VALUE");

  // 3. Try to set a value for the second metric, which should fail because it's disabled
  assert_eq!(
      Err(_),
      another_metric.set_sync(&glean, "VALUE"),
      "Should fail when disabled"
  );

  // 4. Set a new configuration where the second metric is enabled. This should be merged with the existing configuration.
  let metrics_enabled_config = json!(
      {
          "category.another_string_metric": true,
      }
  )
  .to_string();
  glean.set_metrics_enabled_config(
      MetricsEnabledConfig::try_from(metrics_enabled_config).unwrap(),
  );

  // 5. Now both metrics are enabled, setting a new value should work for both metrics with the merged configurations
  metric.set_sync(&glean, "FINAL VALUE");
  assert_eq!(
      "FINAL VALUE",
      metric.get_value(&glean, "baseline").unwrap(),
      "Should set when still enabled"
  );
  another_metric.set_sync(&glean, "FINAL VALUE");
  assert_eq!(
      "FINAL VALUE",
      another_metric.get_value(&glean, "baseline").unwrap(),
  );
}
</Rust>