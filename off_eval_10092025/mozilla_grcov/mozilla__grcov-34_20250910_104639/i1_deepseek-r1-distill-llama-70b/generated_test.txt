#[test]
fn test_coveralls_plus_output_includes_function_info() {
    let mut buffer = Vec::new();
    let mock_results = vec![(
        "src/main.rs".into(),
        "src/main.rs".into(),
        CovResult {
            functions: vec![
                ("test_function1".to_string(), Function { start: 5, executed: true }),
                ("test_function2".to_string(), Function { start: 10, executed: false }),
            ],
            ..Default::default()
        },
    )];
    let mut cursor = Cursor::new(buffer);

    output_coveralls(
        mock_results.into_iter(),
        "token",
        "service",
        "service_number",
        "service_job_number",
        "commit_sha",
        true,
    );

    let output = String::from_utf8(buffer).unwrap();
    let json: Value = serde_json::from_str(&output).unwrap();

    // Verify that each source file has the functions array
    for source_file in json.as_array().unwrap() {
        let functions = source_file.get("functions").unwrap().as_array().unwrap();
        for func in functions {
            let name = func.get("name").unwrap().as_str().unwrap();
            let start = func.get("start").unwrap().as_u64().unwrap();
            let exec = func.get("exec").unwrap().as_bool().unwrap();

            // Ensure each function has the required fields
            assert!(name.is_some(), "Function name should be present");
            assert!(start.is_some(), "Function start line should be present");
            assert!(exec.is_some(), "Function execution status should be present");
        }
    }
}