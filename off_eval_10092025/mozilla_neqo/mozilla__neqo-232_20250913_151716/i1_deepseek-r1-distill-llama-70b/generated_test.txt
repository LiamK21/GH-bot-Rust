#[test]
fn test_state_change_before_new_stream() {
    let mut conn = Connection::new_client().unwrap();
    let now = Instant::now();

    // Process empty datagram to trigger connection establishment
    let out = conn.process(None, now);
    conn.process(out.dgram(), now);

    // Create a new stream to trigger NewStream event
    let stream_id = conn.new_stream().unwrap();
    let out = conn.process(None, now);
    conn.process(out.dgram(), now);

    // Collect events
    let mut events = VecDeque::new();
    while let Some(event) = conn.next_event() {
        events.push_back(event);
    }

    // Verify the first event is StateChange(Connected)
    assert_eq!(
        events.pop_front().unwrap(),
        ConnectionEvent::StateChange(State::Connected)
    );

    // Verify the next event is NewStream
    assert_eq!(
        events.pop_front().unwrap(),
        ConnectionEvent::NewStream {
            stream_id: stream_id.as_u64(),
            stream_type: stream_id.stream_type()
        }
    );
}