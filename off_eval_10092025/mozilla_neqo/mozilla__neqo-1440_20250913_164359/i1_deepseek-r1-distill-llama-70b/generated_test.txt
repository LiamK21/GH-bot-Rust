#[test]
fn test_datagram_priority() {
    let mut connection = Connection::new();
    let mut builder = FrameBuilder::new();
    let tokens = vec![];

    // Simulate data with different priorities
    connection.streams.write_frames(TransmissionPriority::Critical, &mut builder, &tokens, &mut connection.stats.frame_tx);
    connection.streams.write_frames(TransmissionPriority::Normal, &mut builder, &tokens, &mut connection.stats.frame_tx);

    // Write datagrams
    connection.write_datagram(&mut builder, &tokens, &mut connection.stats.frame_tx);

    // Collect frames
    let frames = builder.frames();

    // After the patch, datagrams should come after all higher priority frames
    let mut expected_order = vec![
        TransmissionPriority::Critical,
        TransmissionPriority::Normal,
        // Datagram frames...
    ];

    // Verify the order of frames
    assert_eq!(frames.len(), expected_order.len());
    for i in 0..frames.len() {
        assert_eq!(frames[i].priority(), expected_order[i]);
    }
}