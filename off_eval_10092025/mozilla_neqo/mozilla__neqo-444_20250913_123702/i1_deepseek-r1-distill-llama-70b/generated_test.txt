#[test]
fn test_read_headers_correctly() {
    let (mut client, mut server, request_stream_id) = connect_and_send_request(true);

    // Send a response with headers
    let headers = vec![
        (String::from(":status"), String::from("200")),
        (String::from("content-length"), String::from("0")),
    ];

    let encoded_headers = server.encoder.encode_header_block(&headers, request_stream_id).unwrap();
    let hframe = HFrame::Headers { header_block: encoded_headers };
    let mut d = Encoder::default();
    hframe.encode(&mut d).unwrap();

    server.conn.stream_send(request_stream_id, d.into()).unwrap();
    server.conn.stream_close_send(request_stream_id).unwrap();

    let out = server.conn.process(None, now());
    client.process(out.dgram(), now());

    // Check that headers are received correctly
    let (received_headers, fin) = client.read_response_headers(request_stream_id).unwrap();
    assert_eq!(received_headers, headers);
    assert_eq!(fin, true);
}