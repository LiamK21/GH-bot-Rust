#[test]
fn test_data_blocked_sent_once() {
    let mut s = SendStream::new(0, 2, 65536);
    let mut flow_mgr = FlowMgrMock::new(65536, 65536);
    s.flow_mgr = Some(flow_mgr);

    // Initial send of 2 bytes
    s.send(b"ab".as_slice()).unwrap();
    assert_eq!(s.next_bytes(), Some((0, &b"ab"[..])));
    assert!(s.flow_mgr.as_ref().unwrap().next().is_none());

    // Second send of 3 bytes, which should use up the remaining credit
    s.send(b"abc".as_slice()).unwrap();
    assert_eq!(s.next_bytes(), Some((2, &b"ab"[..])));

    // Verify that DATA_BLOCKED is sent once after the second send
    s.mark_as_sent(0, 2, false);
    assert_eq!(
        s.flow_mgr.as_ref().unwrap().next().unwrap(),
        Frame::DataBlocked { data_limit: 65536 }
    );
}