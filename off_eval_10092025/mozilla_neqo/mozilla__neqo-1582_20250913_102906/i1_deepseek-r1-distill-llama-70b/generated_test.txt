#[test]
fn test_tx_buffer_next_bytes_optimization() {
    let mut tx_buffer = TxBuffer::default();

    // Add test data
    tx_buffer.add_range(0, 100, RangeState::Send);
    tx_buffer.add_range(100, 200, RangeState::Send);
    tx_buffer.add_range(300, 100, RangeState::Send);

    // Initial next_bytes should return the first range
    let first = tx_buffer.next_bytes().unwrap();
    assert_eq!(first.0, 0);
    assert_eq!(first.1.len(), 100);

    // Next call should return the second contiguous range
    let second = tx_buffer.next_bytes().unwrap();
    assert_eq!(second.0, 100);
    assert_eq!(second.1.len(), 200);

    // Next should return the non-contiguous range
    let third = tx_buffer.next_bytes().unwrap();
    assert_eq!(third.0, 300);
    assert_eq!(third.1.len(), 100);

    // No more ranges
    assert!(tx_buffer.next_bytes().is_none());
}