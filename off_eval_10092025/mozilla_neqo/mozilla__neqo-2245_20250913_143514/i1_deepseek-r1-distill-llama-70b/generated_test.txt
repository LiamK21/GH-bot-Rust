#[test]
fn test_take_ranges_optimization() {
    let mut packets = BTreeMap::new();
    // Initialize with 100 packets
    for i in 1..=100 {
        packets.insert(i, SentPacket { data: Vec::new() });
    }

    let mut sent_packets = SentPackets { packets };

    // Simulate ACK ranges: acknowledge packets 1-2
    let acked_ranges = vec![PacketRange { start: 1, end: 2 }];

    // Before patch, this would cause multiple split_off operations
    let result = sent_packets.take_ranges(acked_ranges);

    // After processing, packets 3-100 should remain
    assert_eq!(sent_packets.packets.len(), 98);
    assert_eq!(result.len(), 2);
}