#[test]
fn test_send_ignore_emsgsize() -> std::io::Result<()> {
    let sender = Socket::new(UdpSocket::bind("127.0.0.1:0")?);
    let receiver = Socket::new(UdpSocket::bind("127.0.0.1:0")?);
    let receiver_addr: std::net::SocketAddr = receiver.inner.local_addr()?;

    // Send an oversized datagram and expect it to fail with EMSGSIZE
    let oversized_datagram = Datagram::new(
        sender.inner.local_addr()?,
        receiver_addr,
    )?;
    // Grow the buffer to a size that exceeds the MTU
    let mut buf = vec![0u8; 65536];
    let len = "Hello World!".len();
    buf[..len].copy_from_slice(b"Hello World!");
    oversized_datagram.buffer = buf;

    assert!(sender.send(&oversized_datagram).is_err(), 
        "Expected send to fail with EMSGSIZE");

    // Send a normal datagram
    let normal_datagram = Datagram::new(
        sender.inner.local_addr()?,
        receiver_addr,
    )?;
    let buf = b"Hello World!";
    normal_datagram.buffer = buf.to_vec();
    sender.send(&normal_datagram)?;

    // Set receiver to blocking mode
    receiver.inner.set_nonblocking(false)?;

    let mut recv_buf = RecvBuf::new();
    let received_datagram = receiver.recv(receiver_addr, &mut recv_buf)?;

    assert_eq!(
        received_datagram.next().unwrap().as_ref(),
        b"Hello World!"
    );

    Ok(())
}