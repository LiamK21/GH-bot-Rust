<Filename>glean-core/src/upload/mod.rs</Filename>
<imports>
use super::PingUploadManager;
use super::PingUploadTask;
use super::MAX_RECOVERABLE_FAILURES_PER_UPLOADING_WINDOW;
use crate::Glean;
use crate::PingType;
use crate::upload::result::UploadResult::RecoverableFailure;
use std::thread;
use std::time::Duration;
</imports>
<Rust>
#[test]
fn test_limit_retries_for_failed_ping_uploads() {
    let (mut glean, _) = new_glean(None);

    while glean.get_upload_task() == PingUploadTask::Wait {
        thread::sleep(Duration::from_millis(10));
    }

    let ping_type = PingType::new("test", true, true, vec![]);
    glean.register_ping_type(&ping_type);

    let n = 5;
    for _ in 0..n {
        glean.submit_ping(&ping_type, None).unwrap();
    }

    for _ in 0..MAX_RECOVERABLE_FAILURES_PER_UPLOADING_WINDOW {
        match glean.get_upload_task() {
            PingUploadTask::Upload(req) => {
                glean.process_ping_upload_response(&req.document_id, RecoverableFailure)
            }
            _ => panic!("Expected upload manager to return the next request!"),
        }
    }

    assert_eq!(glean.get_upload_task(), PingUploadTask::Done);

    for _ in 0..n {
        match glean.get_upload_task() {
            PingUploadTask::Upload(_) => {}
            _ => panic!("Expected upload manager to return the next request!"),
        }
    }
}
</Rust>