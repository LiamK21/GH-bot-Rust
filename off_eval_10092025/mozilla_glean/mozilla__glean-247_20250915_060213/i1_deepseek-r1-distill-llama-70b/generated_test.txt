#[test]
fn test_experiment_extras_limits() {
    let t = tempfile::tempdir().unwrap();
    let name = t.path().display().to_string();
    let glean = Glean::with_options(&name, "org.mozilla.glean.tests", true).unwrap();

    let experiment_id = "test-experiment_id".to_string();
    let branch_id = "test-branch-id".to_string();
    let mut extras = HashMap::new();

    let too_long_key = "0123456789".repeat(5);
    let too_long_value = "0123456789".repeat(6);

    // Test exceeding all limits
    for n in 0..21 {
        extras.insert(format!("{}-{}", n, too_long_key), too_long_value.clone());
    }

    glean.set_experiment_active(experiment_id.clone(), branch_id.clone(), Some(extras.clone()));

    let experiment_data = glean.test_get_experiment_data_as_json(experiment_id.clone()).unwrap();
    let parsed_json: RecordedExperimentData = from_str(&experiment_data).unwrap();

    // Check count limit
    assert_eq!(parsed_json.extra.unwrap().len(), 20);

    // Check key and value length limits
    for (key, value) in parsed_json.extra.unwrap().iter() {
        assert!(key.len() <= 30);
        assert!(value.len() <= 50);
    }

    // Test exact limits
    let exact_key = "0".repeat(30);
    let exact_value = "0".repeat(50);
    let mut exact_extras = HashMap::new();
    exact_extras.insert(exact_key, exact_value);

    glean.set_experiment_active(experiment_id.clone(), branch_id.clone(), Some(exact_extras));

    let exact_data = glean.test_get_experiment_data_as_json(experiment_id.clone()).unwrap();
    let exact_json: RecordedExperimentData = from_str(&exact_data).unwrap();

    for (key, value) in exact_json.extra.unwrap().iter() {
        assert_eq!(key.len(), 30);
        assert_eq!(value.len(), 50);
    }
}