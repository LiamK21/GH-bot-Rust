#glean-core/rlb/src/core_metrics.rs
// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at https://mozilla.org/MPL/2.0/.

use crate::system;

/// Metrics included in every ping as `client_info`.
#[derive(Debug)]
pub struct ClientInfoMetrics {
    /// The build identifier generated by the CI system (e.g. "1234/A").
    pub app_build: String,
    /// The user visible version string (e.g. "1.0.3").
    pub app_display_version: String,
    /// The product-provided release channel (e.g. "beta").
    pub channel: Option<String>,
}

impl ClientInfoMetrics {
    /// Creates the client info with dummy values for all.
    pub fn unknown() -> Self {
        ClientInfoMetrics {
            app_build: "Unknown".to_string(),
            app_display_version: "Unknown".to_string(),
            channel: None,
        }
    }
}

impl From<ClientInfoMetrics> for glean_core::ClientInfoMetrics {
    fn from(metrics: ClientInfoMetrics) -> Self {
        glean_core::ClientInfoMetrics {
            app_build: metrics.app_build,
            app_display_version: metrics.app_display_version,
            channel: metrics.channel,
            os_version: system::get_os_version(),
            architecture: system::ARCH.to_string(),
            ..Default::default()
        }
    }
}

#[cfg(test)]
mod tests {
use super::get_windows_build_number;
use super::get_os_version;
use crate::ClientInfoMetrics;

#[test]
fn test_windows_build_number_included_in_os_version() {
  let client_info = ClientInfoMetrics {
    os_version: get_os_version(),
    windows_build_number: get_windows_build_number(),
    ..Default::default()
  };
  let expected_os_version = "10.0.22000"; // example build number
  let actual_os_version = client_info.os_version;
  if let Some(build_number) = client_info.windows_build_number {
    let expected_os_version_with_build = format!("{}.{}", "10.0", build_number);
    assert_eq!(expected_os_version_with_build, actual_os_version);
  } else {
    assert_eq!(expected_os_version, actual_os_version);
  }
}
}
