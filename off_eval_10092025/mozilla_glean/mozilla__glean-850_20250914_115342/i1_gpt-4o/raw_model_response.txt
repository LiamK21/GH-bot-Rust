<Filename>glean-core/src/lib_unit_tests.rs</Filename>
<imports>
use super::timing_distribution_truncation;
use crate::metrics::{TimingDistributionMetric, TimeUnit};
use std::collections::HashSet;
use std::iter::FromIterator;
</imports>
<Rust>
#[test]
fn test_timing_distribution_truncation_with_edge_cases() {
    let dir = tempfile::tempdir().unwrap();
    let (glean, _) = new_glean(Some(dir));
    let max_sample_time = 1000 * 1000 * 1000 * 60 * 10;

    for (unit, expected_keys) in &[
        (
            TimeUnit::Nanosecond,
            HashSet::<u64>::from_iter(vec![1, 961_548, 939, 599_512_966_122]),
        ),
        (
            TimeUnit::Microsecond,
            HashSet::<u64>::from_iter(vec![1, 939, 562_949_953_421_318, 599_512_966_122]),
        ),
        (
            TimeUnit::Millisecond,
            HashSet::<u64>::from_iter(vec![1, 961_548, 576_460_752_303_431_040, 599_512_966_122]),
        ),
    ] {
        let mut dist = TimingDistributionMetric::new(
            CommonMetricData {
                name: format!("local_metric_{:?}", unit),
                category: "local".into(),
                send_in_pings: vec!["baseline".into()],
                ..Default::default()
            },
            *unit,
        );

        for &value in &[
            0,
            1,
            1_000,
            1_000_000,
            max_sample_time,
            max_sample_time * 1_000,
            max_sample_time * 1_000_000,
        ] {
            let timer_id = dist.set_start(0);
            dist.set_stop_and_accumulate(&glean, timer_id, value);
        }

        let hist = dist.test_get_value(&glean, "baseline").unwrap();

        assert_eq!(4, hist.values().len());
        for &key in hist.values().keys() {
            assert!(key < max_sample_time * unit.as_nanos(1))
        }

        let keys = HashSet::<u64>::from_iter(hist.values().keys().cloned());
        assert_eq!(keys, *expected_keys);

        let snapshot = hist.snapshot();
        assert!(snapshot.len() < 316);
    }
}
</Rust>