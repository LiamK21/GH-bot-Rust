#[test]
fn test_recv_multiple_datagrams() -> Result<(), io::Error> {
    let receiver_addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
    let mut receiver = Socket::bind(receiver_addr)?;

    let sender_addr: SocketAddr = "127.0.0.1:0".parse().unwrap();
    let mut sender = Socket::bind(sender_addr)?;

    // Send three empty datagrams
    for _ in 0..3 {
        sender.send(&mut Datagram::new(
            sender_addr,
            receiver_addr,
            IpTos::default(),
            None,
            Vec::new(),
        ))?;
    }

    // Wait for all datagrams to be received
    task::spawn(async move {
        receiver.readable().await?;
    }).await?;

    let datagrams = receiver.recv(&receiver_addr)?;

    assert_eq!(3, datagrams.len());
    Ok(())
}