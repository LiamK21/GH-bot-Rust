#[test]
fn test_zero_rtt_rejection() {
    let mut client = Connection::new_client(
        "example.com",
        &["hq-22"],
        loopback(),
        &["key"],
    ).unwrap();
    let mut server = Connection::new_server(
        &["hq-22"],
        loopback(),
        &["key"],
    ).unwrap();

    let client_initial = client.process(None, now()).dgram();
    let server_hs = server.process(client_initial, now()).dgram();
    let client_hs = client.process(server_hs, now()).dgram();
    let server_hs = server.process(client_hs, now()).dgram();

    let stream_id = client.stream_create(StreamType::UniDi).unwrap();
    let msg = &[0u8; 10];
    client.stream_send(stream_id, msg).unwrap();
    let client_0rtt = client.process(None, now()).dgram();
    let server_out = server.process(client_0rtt, now()).dgram();
    assert!(server_out.is_some());

    let client_fin = client.process(server_hs, now());
    let recvd_0rtt_reject = |e| e == ConnectionEvent::ZeroRttRejected;
    assert!(client.events().any(recvd_0rtt_reject));

    let res = client.stream_send(stream_id, msg);
    assert!(res.is_err());
    assert_eq!(res.unwrap_err(), Error::InvalidStreamId);

    let stream_id_after_reject = client.stream_create(StreamType::UniDi).unwrap();
    assert_eq!(stream_id, stream_id_after_reject);
    client.stream_send(stream_id_after_reject, msg).unwrap();
    let client_after_reject = client.process(None, now());
    assert!(client_after_reject.as_dgram_ref().is_some());

    let server_out = server.process(client_after_reject.dgram(), now());
    assert!(server_out.as_dgram_ref().is_some());
    let recvd_stream_evt = |e| matches!(e, ConnectionEvent::NewStream { .. });
    assert!(server.events().any(recvd_stream_evt));
}