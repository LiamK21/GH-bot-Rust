#[test]
fn test_0rtt_rejection_discharge_keys() {
    let mut client = Connection::new_client("localhost".into(), &["hq-22"]);
    let mut server = Connection::new_server("localhost".into(), &["hq-22"]);

    let client_initial = client.process(None, 0);
    let server_initial = server.process(client_initial.dgram(), 0);
    let client_2 = client.process(server_initial.dgram(), 0);

    let client_0rtt = client.process(None, 0);
    let server_reject = server.process(client_0rtt.dgram(), 0);

    let client_reject = client.process(server_reject.dgram(), 0);
    assert!(client_reject.as_dgram_ref().is_none());

    let stream_id = client.stream_create(StreamType::BiDi).unwrap();
    let result = client.stream_send(stream_id, &[1]);
    assert!(result.is_err());

    let new_stream_id = client.stream_create(StreamType::BiDi).unwrap();
    assert_eq!(stream_id, new_stream_id);

    let client_send = client.process(None, 0);
    assert!(client_send.as_dgram_ref().is_some());

    let server_out = server.process(client_send.dgram(), 0);
    assert!(server_out.as_dgram_ref().is_some());

    let recvd_stream = |e| matches!(e, ConnectionEvent::NewStream { .. });
    assert!(server.events().any(recvd_stream));
}