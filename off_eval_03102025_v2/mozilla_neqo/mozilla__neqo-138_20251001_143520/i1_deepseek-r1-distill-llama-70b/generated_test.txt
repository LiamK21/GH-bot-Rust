#[test]
fn test_idle_timeout_reset_by_send_and_receive() {
    let mut client = default_client();
    let mut server = default_server();
    connect(&mut client, &mut server);

    let now = now();

    let res = client.process(None, now);
    assert_eq!(res, Output::Callback(Duration::from_secs(60)));

    // Send a packet after 30 seconds
    client.process(None, now + Duration::from_secs(30));
    let out = client.process_output(now + Duration::from_secs(30));
    assert_ne!(out.as_dgram_ref(), None);
    server.process_input(out.dgram().unwrap(), now + Duration::from_secs(30));

    // Receive a packet after another 30 seconds
    let out = server.process_output(now + Duration::from_secs(60));
    assert_ne!(out.as_dgram_ref(), None);
    client.process_input(out.dgram().unwrap(), now + Duration::from_secs(60));

    // Connection should still be open after 60 seconds
    assert!(matches!(client.state(), State::Connected));

    // After another 60 seconds, connection should close
    client.process_timer(now + Duration::from_secs(120));
    assert!(matches!(client.state(), State::Closing { .. }));
}