#[test]
fn test_check_delays_retries() {
    let (sender, receiver) = mpsc::channel();

    // Mock the first validate_delays call to fail, then pass on retry
    let mut validate_delays = move || {
        if sender.send(()).unwrap() {
            Err(())
        } else {
            Ok(())
        }
    };

    let max_lag = Duration::from_millis(10);
    let handle = std::thread::spawn({
        let receiver = receiver.clone();
        move || {
            let result = check_delays(max_lag);
            receiver.send(result).unwrap();
        }
    });

    // First call fails, second call passes
    assert_eq!(validate_delays(), Err(()));
    assert_eq!(validate_delays(), Ok(()));

    handle.join().unwrap();
}