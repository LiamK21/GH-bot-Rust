#[test]
fn test_datagram_priority() {
    struct MockFrameBuilder {
        called_with_priority: Vec<TransmissionPriority>,
    }

    impl FrameBuilder for MockFrameBuilder {
        fn is_full(&self) -> bool {
            false
        }

        fn write(&mut self, _data: &[u8]) -> usize {
            0
        }

        fn finish(&mut self) -> Vec<u8> {
            Vec::new()
        }

        fn write_frames(
            &mut self,
            priority: TransmissionPriority,
            _builder: &mut dyn FrameBuilder,
            _tokens: usize,
            _frame_stats: &mut dyn std::any::Any,
        ) {
            self.called_with_priority.push(priority);
        }
    }

    let mut connection = Connection::new(Arc::new(MockFrameBuilder {
        called_with_full: false,
        called_with_priority: Vec::new(),
    }));

    let expected_order = vec![
        TransmissionPriority::Critical,
        TransmissionPriority::Important,
        TransmissionPriority::High,
        TransmissionPriority::Normal,
        // Datagrams should come after all streams
    ];

    connection.write_frames();

    assert_eq!(
        connection.frame_builder.called_with_priority,
        expected_order
    );
}