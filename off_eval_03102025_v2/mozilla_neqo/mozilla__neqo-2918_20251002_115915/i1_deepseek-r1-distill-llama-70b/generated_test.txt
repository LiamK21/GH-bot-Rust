#[test]
fn test_pmtud_batch_closing() {
    let mut path = Path::default();
    let mut pmtud = Pmtud::new();
    pmtud.probe_sent = true;
    path.borrow_mut().set_pmtud(pmtud);

    let initial_mtu = 100;
    path.borrow_mut().set_plpmtu(initial_mtu);

    let mut connection = Connection::new();

    // Simulate data to send
    let data = vec![1; 200];

    let send_option = connection.send(&data, &mut path, 0).unwrap();

    // Simulate PMTUD probing by increasing MTU after first datagram
    let new_mtu = initial_mtu + 50;
    path.borrow_mut().set_plpmtu(new_mtu);

    let result = connection.output_dgram_batch_on_path(
        &data,
        &path,
        0,
        1,
        initial_mtu,
        SendOption::Yes,
        &mut connection.stats.borrow_mut(),
    ).unwrap();

    // Verify that the batch was closed early due to PMTUD change
    assert!(result.batch.len() < initial_mtu);
    assert_eq!(result.batch.len() % result.datagram_size.unwrap(), 0);
}