<Filename> neqo-transport/src/connection/mod.rs </Filename>
<imports> 
use super::Connection;
use super::SendOptionBatch;
use neqo_common::datagram::DatagramBatch;
use neqo_transport::connection::params::max_datagrams;
use std::sync::{Arc, Mutex};
</imports>
<Rust>
#[test]
fn test_gso_with_pmtud_produces_consistent_segment_sizes() {
  let connection = Connection::new();
  let path = Arc::new(Mutex::new(connection.new_path()));
  let max_datagrams = 5;
  let mtu = 1000;
  path.lock().unwrap().set_plpmtu(mtu);
  path.lock().unwrap().set_pmtud.needs_probe(true);
  let send_option_batch = connection.output_dgram_batch_on_path(path, max_datagrams).unwrap();
  let send_buffer = send_option_batch.send_buffer;
  let datagram_size = send_option_batch.datagram_size;
  let num_datagrams = send_option_batch.num_datagrams;
  assert!(num_datagrams > 0);
  assert_eq!(send_buffer.len() % datagram_size, 0);
  for i in 0..num_datagrams-1 {
    assert_eq!(send_buffer[i*datagram_size..(i+1)*datagram_size].len(), datagram_size);
  }
  assert!(send_buffer[(num_datagrams-1)*datagram_size..].len() <= datagram_size);
}</Rust>