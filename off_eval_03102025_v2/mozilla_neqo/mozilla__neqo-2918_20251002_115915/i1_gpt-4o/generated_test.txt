#[test]
fn test_output_dgram_batch_on_path_with_pmtud() {
    let path = Rc::new(RefCell::new(Path::new()));
    let mut connection = Connection::new();
    let max_datagrams = 10;
    let now = Instant::now();
    let mut packet_builder = PacketBuilder::new();
    let mut stats = Stats::default();

    // Simulate PMTUD behavior
    path.borrow_mut().set_plpmtu(1200);
    path.borrow_mut().pmtud().set_needs_probe(true);

    let result = connection.output_dgram_batch_on_path(
        &path,
        &mut packet_builder,
        &max_datagrams,
        now,
    );

    assert!(result.is_ok());
    let send_option_batch = result.unwrap();
    assert!(send_option_batch.num_datagrams <= max_datagrams);
    assert!(send_option_batch.datagram_size <= path.borrow().plpmtu());
}