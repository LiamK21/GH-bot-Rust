#[test]
fn test_event_order_state_before_new_stream() {
    let mut events = ConnectionEvents::default();
    let stream_id = StreamId::from(1);

    // Transition to connected state
    events.connection_state_change(State::Connected);

    // Add a new stream event
    events.new_stream(stream_id);

    // Collect all events
    let mut event_order = Vec::new();
    while let Some(event) = events.next_event() {
        event_order.push(event);
    }

    // The StateChange event should come before any NewStream events
    let mut state_change_found = false;
    for event in &event_order {
        if let ConnectionEvent::StateChange(State::Connected) = event {
            state_change_found = true;
        } else if let ConnectionEvent::NewStream { .. } = event {
            if !state_change_found {
                panic!("NewStream event found before StateChange event");
            }
        }
    }

    assert!(state_change_found, "StateChange event was not found");
}