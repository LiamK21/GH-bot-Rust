<Filename> glean-core/src/upload/mod.rs </Filename>
<imports> 
use glean_core::upload::PingUploadManager;
use glean_core::upload::PingUploadTask;
use std::thread;
use std::time::Duration;
use tempfile::tempdir;
use serde_json::json;
</imports>
<Rust>
#[test]
fn test_rate_limiting_for_pings() {
  // Create a new upload_manager
  let dir = tempdir().unwrap();
  let mut upload_manager = PingUploadManager::new(dir.path(), false);

  // Add a rate limiter to the upload mangager with max of 1 ping every 3 seconds.
  let secs_per_interval = 3;
  let max_pings_per_interval = 1;
  upload_manager.set_rate_limiter(secs_per_interval, max_pings_per_interval);

  // Enqueue a ping.
  upload_manager.enqueue_ping("document_id", "path", json!({}));

  // Enqueue another ping immediately.
  upload_manager.enqueue_ping("document_id_2", "path_2", json!({}));

  // Verify that we are indeed told to wait because we are at capacity
  assert_eq!(PingUploadTask::Wait, upload_manager.get_upload_task(false));

  thread::sleep(Duration::from_secs(secs_per_interval));

  // Verify that we can upload after the rate limit time has passed.
  assert_ne!(PingUploadTask::Wait, upload_manager.get_upload_task(false));
}
</Rust>