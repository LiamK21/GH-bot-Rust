<Filename>glean-core/src/upload/mod.rs</Filename>
<imports>
use super::setup_upload_manager;
use std::sync::Arc;
use std::sync::atomic::AtomicBool;
use std::path::PathBuf;
use tempfile;
use serde_json::json;
use std::thread;
use std::time::Duration;
use crate::PingUploadManager;
use crate::PingUploadTask;
</imports>
<Rust>
#[test]
fn test_setup_upload_manager_with_rate_limiting() {
    let dir = tempfile::tempdir().unwrap();
    let upload_manager = PingUploadManager::new(dir.path(), false);
    setup_upload_manager(upload_manager).unwrap();

    let mut upload_manager = PingUploadManager::new(dir.path(), false);
    upload_manager.set_rate_limiter(60, 10);

    while upload_manager.get_upload_task(false) == PingUploadTask::Wait {
        thread::sleep(Duration::from_millis(10));
    }

    for _ in 0..10 {
        upload_manager.enqueue_ping("document_id", "path", json!({}));
    }

    for _ in 0..10 {
        match upload_manager.get_upload_task(false) {
            PingUploadTask::Upload(_) => {}
            _ => panic!("Expected upload manager to return the next request!"),
        }
    }

    upload_manager.enqueue_ping("document_id", "path", json!({}));

    assert_eq!(PingUploadTask::Wait, upload_manager.get_upload_task(false));

    thread::sleep(Duration::from_secs(60));

    match upload_manager.get_upload_task(false) {
        PingUploadTask::Upload(_) => {}
        _ => panic!("Expected upload manager to return the next request!"),
    }
}
</Rust>