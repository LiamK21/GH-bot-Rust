#[test]
fn test_upgrade_ping_sent_on_build_change() {
    let (mut glean, _t) = new_glean(None);

    let old_build = "old_build";
    let new_build = "new_build";
    glean.app_build = new_build.into();

    let lsb_metric = get_last_sent_build_metric();
    lsb_metric.set_sync(glean, old_build);

    let fake_now = FixedOffset::east(0)
        .ymd(2022, 11, 16)
        .and_hms(SCHEDULED_HOUR, 0, 1);

    let (submitter, submitter_count, scheduler, scheduler_count) = new_proxies(
        |_, reason| assert_eq!(reason, Some("upgrade")),
        |_, when| assert_eq!(when, When::Reschedule),
    );

    schedule_internal(&glean, submitter, scheduler, fake_now);

    assert_eq!(1, submitter_count.swap(0, Ordering::Relaxed));
    assert_eq!(1, scheduler_count.swap(0, Ordering::Relaxed));

    assert_eq!(
        Some(new_build.to_string()),
        lsb_metric.get_value(&glean, Some(INTERNAL_STORAGE))
    );
}