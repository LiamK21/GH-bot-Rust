#[test]
fn test_date_header_set_at_upload_time() {
    let old_time = Utc::now();
    // Simulate some delay, but in reality, this could be much longer.
    std::thread::sleep(std::time::Duration::seconds(1));

    let request = {
        let mut headers = HeaderMap::new();
        headers.insert("Content-Type".to_string(), "application/x-www-form-urlencoded".to_string());
        headers.insert("Content-Length".to_string(), "0".to_string());
        headers
    };

    let task = PingUploadTask::Upload { request };

    // After the patch, the Date header should be set here, just before returning the task.
    let expected_date = create_date_header_value(Utc::now());

    // The Date header should reflect the current time, not the old_time.
    assert_eq!(task.request.headers["Date"], expected_date);
}