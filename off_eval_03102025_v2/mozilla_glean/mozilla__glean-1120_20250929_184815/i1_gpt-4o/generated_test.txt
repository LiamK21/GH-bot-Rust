#[test]
fn test_limit_retries_on_recoverable_failures() {
    let (mut glean, _) = new_glean(None);

    while glean.get_upload_task() == PingUploadTask::Wait {
        thread::sleep(Duration::from_millis(10));
    }

    let ping_type = PingType::new("test", true, true, vec![]);
    glean.register_ping_type(&ping_type);

    let n = 5;
    for _ in 0..n {
        glean.submit_ping(&ping_type, None).unwrap();
    }

    for _ in 0..MAX_RECOVERABLE_FAILURES_PER_UPLOADING_WINDOW {
        match glean.get_upload_task() {
            PingUploadTask::Upload(req) => {
                glean.process_ping_upload_response(&req.document_id, RecoverableFailure)
            }
            _ => panic!("Expected upload manager to return the next request!"),
        }
    }

    assert_eq!(glean.get_upload_task(), PingUploadTask::Done);

    for _ in 0..n {
        match glean.get_upload_task() {
            PingUploadTask::Upload(_) => {}
            _ => panic!("Expected upload manager to return the next request!"),
        }
    }
}