#[test]
fn test_event_metric_record_with_new_format() {
    #[derive(Default, Debug, Clone, Hash, Eq, PartialEq)]
    struct TestExtra {
        key1: Option<String>,
        key2: Option<String>,
    }

    impl crate::traits::ExtraKeys for TestExtra {
        const ALLOWED_KEYS: &'static [&'static str] = &["key1", "key2"];

        fn into_ffi_extra(self) -> HashMap<i32, String> {
            let mut map = HashMap::new();
            self.key1.and_then(|key1| map.insert(0, key1));
            self.key2.and_then(|key2| map.insert(1, key2));
            map
        }
    }

    let metric = EventMetric::<TestExtra>::new("category", "name", "test");

    let map1 = TestExtra {
        key1: Some("value1".into()),
        ..Default::default()
    };
    metric.record(map1);

    let map2 = TestExtra {
        key1: Some("value1".into()),
        key2: Some("value2".into()),
    };
    metric.record(map2);

    metric.record(None);
}