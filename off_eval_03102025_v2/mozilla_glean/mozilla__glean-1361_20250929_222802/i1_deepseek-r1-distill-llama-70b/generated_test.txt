#[test]
fn test_error_recording() {
    let _lock = lock_test();
    let _t = new_glean(None, true);

    #[derive(Debug, Clone, Copy, Hash, Eq, PartialEq)]
    enum SomeExtra {
        Key1,
        Key2,
    }

    impl glean_core::traits::ExtraKeys for SomeExtra {
        const ALLOWED_KEYS: &'static [&'static str] = &["key1", "key2"];

        fn index(self) -> i32 {
            self as i32
        }
    }

    let metric: EventMetric<SomeExtra> = EventMetric::new(CommonMetricData {
        name: "event".into(),
        category: "test".into(),
        send_in_pings: vec!["test1".into()],
        ..Default::default()
    });

    let mut map = HashMap::new();
    map.insert(SomeExtra::Key1, "1".into());
    metric.record(map);

    let mut map = HashMap::new();
    map.insert(SomeExtra::Key1, "1".into());
    map.insert(SomeExtra::Key2, "2".into());
    metric.record(map);

    let invalid_key = SomeExtra::Key1;
    let mut map = HashMap::new();
    map.insert(invalid_key, "invalid".into());
    metric.record(map);

    let error_count = metric.test_get_num_recorded_errors(ErrorType::InvalidExtraKey, None);
    assert_eq!(1, error_count);
}