#[test]
fn test_scheduler_lock_order_inversion() {
    let submitter = MockSubmitter {};
    let now = DateTime::parse_from_rfc3339("2023-10-01T12:00:00+00:00").unwrap();
    let when = When::Reschedule;
    let cancelled = Arc::new((Mutex::new(false), Condvar::new()));
    let cancelled_clone = Arc::clone(&cancelled);

    let handle = thread::spawn(move || {
        start_scheduler(submitter, now, when);
    });

    thread::sleep(Duration::from_millis(100));
    {
        let (lock, cvar) = &*cancelled_clone;
        let mut cancelled = lock.lock().unwrap();
        *cancelled = true;
        cvar.notify_one();
    }

    handle.join().unwrap();
}

struct MockSubmitter;

impl MetricsPingSubmitter for MockSubmitter {
    fn submit_metrics_ping(&self, _glean: &Glean, _reason: Option<&str>, _now: DateTime<FixedOffset>) {}
}