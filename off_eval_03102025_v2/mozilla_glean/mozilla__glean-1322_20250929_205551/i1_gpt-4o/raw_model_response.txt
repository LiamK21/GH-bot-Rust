<Filename>glean-core/src/database/mod.rs</Filename>
<imports>
use super::migrate;
use rkv::Rkv;
use rkv::backend::SafeModeEnvironment;
use std::fs;
use std::path::Path;
use tempfile::tempdir;
</imports>
<Rust>
#[test]
fn test_migrate_lmdb_to_safe_mode() {
    let dir = tempdir().unwrap();
    let database_dir = dir.path().join("db");
    let datamdb = database_dir.join("data.mdb");
    let lockmdb = database_dir.join("lock.mdb");
    let safebin = database_dir.join("data.safe.bin");

    fs::create_dir_all(&database_dir).expect("create dir");
    let rkv_db = rkv::Rkv::new::<rkv::backend::Lmdb>(&database_dir).expect("rkv env");
    drop(rkv_db);

    assert!(datamdb.exists());
    assert!(lockmdb.exists());
    assert!(!safebin.exists());

    let rkv_safe = Rkv::new::<SafeModeEnvironment>(&database_dir).expect("rkv safe env");
    migrate(&database_dir, &rkv_safe);

    assert!(!datamdb.exists(), "LMDB data should be deleted");
    assert!(!lockmdb.exists(), "LMDB lock should be deleted");
    assert!(safebin.exists(), "safe-mode file should exist");
}
</Rust>