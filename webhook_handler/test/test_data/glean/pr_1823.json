{
  "action": "opened",
  "number": 1823,
  "pull_request": {
    "url": "https://api.github.com/repos/mozilla/glean/pulls/1823",
    "id": 754143080,
    "node_id": "PR_kwDOCZG2yc4s809o",
    "html_url": "https://github.com/mozilla/glean/pull/1823",
    "diff_url": "https://github.com/mozilla/glean/pull/1823.diff",
    "patch_url": "https://github.com/mozilla/glean/pull/1823.patch",
    "issue_url": "https://api.github.com/repos/mozilla/glean/issues/1823",
    "number": 1823,
    "state": "closed",
    "locked": false,
    "title": "Bug 1733757 - Store created label metrics to avoid rapidly reconstructing them all \u2026",
    "user": {
      "login": "badboy",
      "id": 2129,
      "node_id": "MDQ6VXNlcjIxMjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2129?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/badboy",
      "html_url": "https://github.com/badboy",
      "followers_url": "https://api.github.com/users/badboy/followers",
      "following_url": "https://api.github.com/users/badboy/following{/other_user}",
      "gists_url": "https://api.github.com/users/badboy/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/badboy/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/badboy/subscriptions",
      "organizations_url": "https://api.github.com/users/badboy/orgs",
      "repos_url": "https://api.github.com/users/badboy/repos",
      "events_url": "https://api.github.com/users/badboy/events{/privacy}",
      "received_events_url": "https://api.github.com/users/badboy/received_events",
      "type": "User",
      "user_view_type": "public",
      "site_admin": false
    },
    "body": "\u2026the time\r\n\r\nThis fixes a crashing bug, that probably started being an issue since\r\nMarch 2020 / Glean v26, when we removed finalizers from the Kotlin\r\nlibrary[1]. Depending on how GC runs it was theoretically possible to\r\nhit that even with finalizers in the SDK.\r\n\r\nContrary to the commit message in [1] we do have one more place where we\r\ndynamically construct metrics: Labeled Metrics!\r\nIt used to be the case that whenever you access the submetric of a\r\nlabeled metric, that is `Metrics.Category.Name[\"label\"]`, we created a\r\nnew Rust object, put that into the internal ConcurrentHandleMap and\r\nreturned a handle to it.\r\n\r\nA ConcurrentHandleMap does a lot of work to ensure that you can't misuse\r\nhandles against the wrong map, when the item was already replaced, etc.\r\nIt also sets an upper limit of entries it can handle[2].\r\nThat limit is high enough for the static use of Rust (you would have to\r\nuse 32767+ metrics of a single type), but quickly[3] breaks down\r\n\r\nThe solution is to not re-create labeled submetrics on every access.\r\nWe cache those ourselves now, identified by the parent's metric handle\r\nand the label.\r\nNow accessing the same label 32768+ times is fine, you get the same\r\nRust object every time (as long as it exists).\r\n\r\nThere's one last piece: We do expose a way to destroy metrics, even if\r\nthat shouldn't happen for any statically defined ones.\r\nThis is not happening on Kotlin, where we removed finalizers some time\r\nago [1].\r\nWe're now removing those finalizers on Swift and Python as well.\r\nWe could try to get smart and do some double-checks that the handle is\r\nnot stale when the submetric is accessed.\r\nBut that breaks down quickly, because the metric could be destroyed\r\nbetween the access and the recording, still leading to issues.\r\nThe only way to handle that would be some reference counting on the\r\nobject itself, but the current implementation doens't easily allow that.\r\nSo for now we just don't destroy boolean/counter/string metrics, ever.\r\n\r\nThe included tests fail without the corresponding library changes,\r\ngiving us a bit more confidence that the fix works.\r\n\r\nNow there's still one way to trigger a crash, in theory:\r\nKeep accessing previously-unused labels 32768+ times.\r\nIf you do that you're really on your own.\r\n\r\n[1]: https://github.com/mozilla/glean/commit/25bf9ea0b26791f80235e2a421884ee63aae2326\r\n[2]: https://github.com/mozilla/ffi-support/blob/0fdc22a8dfe3731be5fd39b311e4e4885219e26c/src/handle_map.rs#L160-L166\r\n[3]: Well, \"quickly\". Reproducing that on get.webgl.org takes 8+ minutes.",
    "created_at": "2021-10-08T15:29:16Z",
    "updated_at": "2021-10-11T09:07:37Z",
    "closed_at": "2021-10-11T09:07:35Z",
    "merged_at": "2021-10-11T09:07:35Z",
    "merge_commit_sha": "6c3be0363ce4060dd5228ec517f4e558a6230c44",
    "assignee": null,
    "assignees": [],
    "requested_reviewers": [],
    "requested_teams": [],
    "labels": [],
    "milestone": null,
    "draft": false,
    "commits_url": "https://api.github.com/repos/mozilla/glean/pulls/1823/commits",
    "review_comments_url": "https://api.github.com/repos/mozilla/glean/pulls/1823/comments",
    "review_comment_url": "https://api.github.com/repos/mozilla/glean/pulls/comments{/number}",
    "comments_url": "https://api.github.com/repos/mozilla/glean/issues/1823/comments",
    "statuses_url": "https://api.github.com/repos/mozilla/glean/statuses/499309475f4f002bdd6c19db4aa051634760efe1",
    "head": {
      "label": "mozilla:fenix-crashes",
      "ref": "fenix-crashes",
      "sha": "499309475f4f002bdd6c19db4aa051634760efe1",
      "user": {
        "login": "mozilla",
        "id": 131524,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjEzMTUyNA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/131524?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mozilla",
        "html_url": "https://github.com/mozilla",
        "followers_url": "https://api.github.com/users/mozilla/followers",
        "following_url": "https://api.github.com/users/mozilla/following{/other_user}",
        "gists_url": "https://api.github.com/users/mozilla/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mozilla/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mozilla/subscriptions",
        "organizations_url": "https://api.github.com/users/mozilla/orgs",
        "repos_url": "https://api.github.com/users/mozilla/repos",
        "events_url": "https://api.github.com/users/mozilla/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mozilla/received_events",
        "type": "Organization",
        "user_view_type": "public",
        "site_admin": false
      },
      "repo": {
        "id": 160544457,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNjA1NDQ0NTc=",
        "name": "glean",
        "full_name": "mozilla/glean",
        "private": false,
        "owner": {
          "login": "mozilla",
          "id": 131524,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjEzMTUyNA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/131524?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/mozilla",
          "html_url": "https://github.com/mozilla",
          "followers_url": "https://api.github.com/users/mozilla/followers",
          "following_url": "https://api.github.com/users/mozilla/following{/other_user}",
          "gists_url": "https://api.github.com/users/mozilla/gists{/gist_id}",
          "starred_url": "https://api.github.com/users/mozilla/starred{/owner}{/repo}",
          "subscriptions_url": "https://api.github.com/users/mozilla/subscriptions",
          "organizations_url": "https://api.github.com/users/mozilla/orgs",
          "repos_url": "https://api.github.com/users/mozilla/repos",
          "events_url": "https://api.github.com/users/mozilla/events{/privacy}",
          "received_events_url": "https://api.github.com/users/mozilla/received_events",
          "type": "Organization",
          "user_view_type": "public",
          "site_admin": false
        },
        "html_url": "https://github.com/mozilla/glean",
        "description": "Modern cross-platform telemetry",
        "fork": false,
        "url": "https://api.github.com/repos/mozilla/glean",
        "forks_url": "https://api.github.com/repos/mozilla/glean/forks",
        "keys_url": "https://api.github.com/repos/mozilla/glean/keys{/key_id}",
        "collaborators_url": "https://api.github.com/repos/mozilla/glean/collaborators{/collaborator}",
        "teams_url": "https://api.github.com/repos/mozilla/glean/teams",
        "hooks_url": "https://api.github.com/repos/mozilla/glean/hooks",
        "issue_events_url": "https://api.github.com/repos/mozilla/glean/issues/events{/number}",
        "events_url": "https://api.github.com/repos/mozilla/glean/events",
        "assignees_url": "https://api.github.com/repos/mozilla/glean/assignees{/user}",
        "branches_url": "https://api.github.com/repos/mozilla/glean/branches{/branch}",
        "tags_url": "https://api.github.com/repos/mozilla/glean/tags",
        "blobs_url": "https://api.github.com/repos/mozilla/glean/git/blobs{/sha}",
        "git_tags_url": "https://api.github.com/repos/mozilla/glean/git/tags{/sha}",
        "git_refs_url": "https://api.github.com/repos/mozilla/glean/git/refs{/sha}",
        "trees_url": "https://api.github.com/repos/mozilla/glean/git/trees{/sha}",
        "statuses_url": "https://api.github.com/repos/mozilla/glean/statuses/{sha}",
        "languages_url": "https://api.github.com/repos/mozilla/glean/languages",
        "stargazers_url": "https://api.github.com/repos/mozilla/glean/stargazers",
        "contributors_url": "https://api.github.com/repos/mozilla/glean/contributors",
        "subscribers_url": "https://api.github.com/repos/mozilla/glean/subscribers",
        "subscription_url": "https://api.github.com/repos/mozilla/glean/subscription",
        "commits_url": "https://api.github.com/repos/mozilla/glean/commits{/sha}",
        "git_commits_url": "https://api.github.com/repos/mozilla/glean/git/commits{/sha}",
        "comments_url": "https://api.github.com/repos/mozilla/glean/comments{/number}",
        "issue_comment_url": "https://api.github.com/repos/mozilla/glean/issues/comments{/number}",
        "contents_url": "https://api.github.com/repos/mozilla/glean/contents/{+path}",
        "compare_url": "https://api.github.com/repos/mozilla/glean/compare/{base}...{head}",
        "merges_url": "https://api.github.com/repos/mozilla/glean/merges",
        "archive_url": "https://api.github.com/repos/mozilla/glean/{archive_format}{/ref}",
        "downloads_url": "https://api.github.com/repos/mozilla/glean/downloads",
        "issues_url": "https://api.github.com/repos/mozilla/glean/issues{/number}",
        "pulls_url": "https://api.github.com/repos/mozilla/glean/pulls{/number}",
        "milestones_url": "https://api.github.com/repos/mozilla/glean/milestones{/number}",
        "notifications_url": "https://api.github.com/repos/mozilla/glean/notifications{?since,all,participating}",
        "labels_url": "https://api.github.com/repos/mozilla/glean/labels{/name}",
        "releases_url": "https://api.github.com/repos/mozilla/glean/releases{/id}",
        "deployments_url": "https://api.github.com/repos/mozilla/glean/deployments",
        "created_at": "2018-12-05T16:09:14Z",
        "updated_at": "2025-09-10T09:50:14Z",
        "pushed_at": "2025-09-10T09:59:50Z",
        "git_url": "git://github.com/mozilla/glean.git",
        "ssh_url": "git@github.com:mozilla/glean.git",
        "clone_url": "https://github.com/mozilla/glean.git",
        "svn_url": "https://github.com/mozilla/glean",
        "homepage": "https://mozilla.github.io/glean/",
        "size": 685863,
        "stargazers_count": 420,
        "watchers_count": 420,
        "language": "Rust",
        "has_issues": true,
        "has_projects": false,
        "has_downloads": true,
        "has_wiki": false,
        "has_pages": true,
        "has_discussions": false,
        "forks_count": 148,
        "mirror_url": null,
        "archived": false,
        "disabled": false,
        "open_issues_count": 9,
        "license": {
          "key": "mpl-2.0",
          "name": "Mozilla Public License 2.0",
          "spdx_id": "MPL-2.0",
          "url": "https://api.github.com/licenses/mpl-2.0",
          "node_id": "MDc6TGljZW5zZTE0"
        },
        "allow_forking": true,
        "is_template": false,
        "web_commit_signoff_required": false,
        "topics": [],
        "visibility": "public",
        "forks": 148,
        "open_issues": 9,
        "watchers": 420,
        "default_branch": "main"
      }
    },
    "base": {
      "label": "mozilla:main",
      "ref": "main",
      "sha": "812388ebc59c0f74f26e808ee978b5ba1d029a96",
      "user": {
        "login": "mozilla",
        "id": 131524,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjEzMTUyNA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/131524?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mozilla",
        "html_url": "https://github.com/mozilla",
        "followers_url": "https://api.github.com/users/mozilla/followers",
        "following_url": "https://api.github.com/users/mozilla/following{/other_user}",
        "gists_url": "https://api.github.com/users/mozilla/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mozilla/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mozilla/subscriptions",
        "organizations_url": "https://api.github.com/users/mozilla/orgs",
        "repos_url": "https://api.github.com/users/mozilla/repos",
        "events_url": "https://api.github.com/users/mozilla/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mozilla/received_events",
        "type": "Organization",
        "user_view_type": "public",
        "site_admin": false
      },
      "repo": {
        "id": 160544457,
        "node_id": "MDEwOlJlcG9zaXRvcnkxNjA1NDQ0NTc=",
        "name": "glean",
        "full_name": "mozilla/glean",
        "private": false,
        "owner": {
          "login": "mozilla",
          "id": 131524,
          "node_id": "MDEyOk9yZ2FuaXphdGlvbjEzMTUyNA==",
          "avatar_url": "https://avatars.githubusercontent.com/u/131524?v=4",
          "gravatar_id": "",
          "url": "https://api.github.com/users/mozilla",
          "html_url": "https://github.com/mozilla",
          "followers_url": "https://api.github.com/users/mozilla/followers",
          "following_url": "https://api.github.com/users/mozilla/following{/other_user}",
          "gists_url": "https://api.github.com/users/mozilla/gists{/gist_id}",
          "starred_url": "https://api.github.com/users/mozilla/starred{/owner}{/repo}",
          "subscriptions_url": "https://api.github.com/users/mozilla/subscriptions",
          "organizations_url": "https://api.github.com/users/mozilla/orgs",
          "repos_url": "https://api.github.com/users/mozilla/repos",
          "events_url": "https://api.github.com/users/mozilla/events{/privacy}",
          "received_events_url": "https://api.github.com/users/mozilla/received_events",
          "type": "Organization",
          "user_view_type": "public",
          "site_admin": false
        },
        "html_url": "https://github.com/mozilla/glean",
        "description": "Modern cross-platform telemetry",
        "fork": false,
        "url": "https://api.github.com/repos/mozilla/glean",
        "forks_url": "https://api.github.com/repos/mozilla/glean/forks",
        "keys_url": "https://api.github.com/repos/mozilla/glean/keys{/key_id}",
        "collaborators_url": "https://api.github.com/repos/mozilla/glean/collaborators{/collaborator}",
        "teams_url": "https://api.github.com/repos/mozilla/glean/teams",
        "hooks_url": "https://api.github.com/repos/mozilla/glean/hooks",
        "issue_events_url": "https://api.github.com/repos/mozilla/glean/issues/events{/number}",
        "events_url": "https://api.github.com/repos/mozilla/glean/events",
        "assignees_url": "https://api.github.com/repos/mozilla/glean/assignees{/user}",
        "branches_url": "https://api.github.com/repos/mozilla/glean/branches{/branch}",
        "tags_url": "https://api.github.com/repos/mozilla/glean/tags",
        "blobs_url": "https://api.github.com/repos/mozilla/glean/git/blobs{/sha}",
        "git_tags_url": "https://api.github.com/repos/mozilla/glean/git/tags{/sha}",
        "git_refs_url": "https://api.github.com/repos/mozilla/glean/git/refs{/sha}",
        "trees_url": "https://api.github.com/repos/mozilla/glean/git/trees{/sha}",
        "statuses_url": "https://api.github.com/repos/mozilla/glean/statuses/{sha}",
        "languages_url": "https://api.github.com/repos/mozilla/glean/languages",
        "stargazers_url": "https://api.github.com/repos/mozilla/glean/stargazers",
        "contributors_url": "https://api.github.com/repos/mozilla/glean/contributors",
        "subscribers_url": "https://api.github.com/repos/mozilla/glean/subscribers",
        "subscription_url": "https://api.github.com/repos/mozilla/glean/subscription",
        "commits_url": "https://api.github.com/repos/mozilla/glean/commits{/sha}",
        "git_commits_url": "https://api.github.com/repos/mozilla/glean/git/commits{/sha}",
        "comments_url": "https://api.github.com/repos/mozilla/glean/comments{/number}",
        "issue_comment_url": "https://api.github.com/repos/mozilla/glean/issues/comments{/number}",
        "contents_url": "https://api.github.com/repos/mozilla/glean/contents/{+path}",
        "compare_url": "https://api.github.com/repos/mozilla/glean/compare/{base}...{head}",
        "merges_url": "https://api.github.com/repos/mozilla/glean/merges",
        "archive_url": "https://api.github.com/repos/mozilla/glean/{archive_format}{/ref}",
        "downloads_url": "https://api.github.com/repos/mozilla/glean/downloads",
        "issues_url": "https://api.github.com/repos/mozilla/glean/issues{/number}",
        "pulls_url": "https://api.github.com/repos/mozilla/glean/pulls{/number}",
        "milestones_url": "https://api.github.com/repos/mozilla/glean/milestones{/number}",
        "notifications_url": "https://api.github.com/repos/mozilla/glean/notifications{?since,all,participating}",
        "labels_url": "https://api.github.com/repos/mozilla/glean/labels{/name}",
        "releases_url": "https://api.github.com/repos/mozilla/glean/releases{/id}",
        "deployments_url": "https://api.github.com/repos/mozilla/glean/deployments",
        "created_at": "2018-12-05T16:09:14Z",
        "updated_at": "2025-09-10T09:50:14Z",
        "pushed_at": "2025-09-10T09:59:50Z",
        "git_url": "git://github.com/mozilla/glean.git",
        "ssh_url": "git@github.com:mozilla/glean.git",
        "clone_url": "https://github.com/mozilla/glean.git",
        "svn_url": "https://github.com/mozilla/glean",
        "homepage": "https://mozilla.github.io/glean/",
        "size": 685863,
        "stargazers_count": 420,
        "watchers_count": 420,
        "language": "Rust",
        "has_issues": true,
        "has_projects": false,
        "has_downloads": true,
        "has_wiki": false,
        "has_pages": true,
        "has_discussions": false,
        "forks_count": 148,
        "mirror_url": null,
        "archived": false,
        "disabled": false,
        "open_issues_count": 9,
        "license": {
          "key": "mpl-2.0",
          "name": "Mozilla Public License 2.0",
          "spdx_id": "MPL-2.0",
          "url": "https://api.github.com/licenses/mpl-2.0",
          "node_id": "MDc6TGljZW5zZTE0"
        },
        "allow_forking": true,
        "is_template": false,
        "web_commit_signoff_required": false,
        "topics": [],
        "visibility": "public",
        "forks": 148,
        "open_issues": 9,
        "watchers": 420,
        "default_branch": "main"
      }
    },
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/mozilla/glean/pulls/1823"
      },
      "html": {
        "href": "https://github.com/mozilla/glean/pull/1823"
      },
      "issue": {
        "href": "https://api.github.com/repos/mozilla/glean/issues/1823"
      },
      "comments": {
        "href": "https://api.github.com/repos/mozilla/glean/issues/1823/comments"
      },
      "review_comments": {
        "href": "https://api.github.com/repos/mozilla/glean/pulls/1823/comments"
      },
      "review_comment": {
        "href": "https://api.github.com/repos/mozilla/glean/pulls/comments{/number}"
      },
      "commits": {
        "href": "https://api.github.com/repos/mozilla/glean/pulls/1823/commits"
      },
      "statuses": {
        "href": "https://api.github.com/repos/mozilla/glean/statuses/499309475f4f002bdd6c19db4aa051634760efe1"
      }
    },
    "author_association": "MEMBER",
    "auto_merge": null,
    "active_lock_reason": null
  },
  "repository": {
    "owner": {
      "login": "mozilla"
    },
    "name": "glean"
  }
}