#[test]
fn test_mapping_applies_before_prefix() {
    let mut result_map = CovResultMap::new();
    result_map.insert(
        "lib/old_path.c".to_string(), 
        empty_result!()
    );

    let path_mapping = Some(serde_json::json!({
        "lib/old_path.c": "lib/new_path.c"
    }));

    let prefix_dir = Some(PathBuf::from("lib"));

    let results: Vec<_> = rewrite_paths(
        result_map,
        path_mapping,
        None,
        prefix_dir,
        true,
        Vec::new(),
        None
    ).collect();

    assert_eq!(results.len(), 1);
    let (_, rel_path, _) = &results[0];
    assert_eq!(rel_path.to_str(), Some("new_path.c"));
}