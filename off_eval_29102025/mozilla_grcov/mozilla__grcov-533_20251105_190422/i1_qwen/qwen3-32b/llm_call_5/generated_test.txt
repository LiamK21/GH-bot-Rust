#[test]
fn test_get_coverage_env_vars_adds_expected_flags() {
    let target_dir = tempfile::tempdir().expect("couldn't create temp dir");
    let target_dir_os = target_dir.path().to_path_buf().into_os_string();

    let project_dir = tempfile::tempdir().expect("couldn't create temp dir");
    let proj_path = project_dir.path().to_path_buf();

    // Create valid Cargo.lock with proper format
    fs::write(
        proj_path.join("Cargo.toml"),
        r#"[package]
name = "test-project"
version = "0.1.0"
edition = "2021"
"#,
    ).expect("write Cargo.toml");

    fs::write(
        proj_path.join("Cargo.lock"),
        r#"[root]
name = "test-project"
version = "0.1.0"
hash = "abc123"
        "#,
    ).expect("write Cargo.lock");

    let mut env = HashMap::new();
    env.insert(OsString::from("CARGO_TARGET_DIR"), target_dir_os);

    let context = Context {
        env,
        pwd: proj_path.clone(),
        args: vec!().into_iter().collect(),
    };

    let result = get_coverage_env_vars(&context.env, "debug");

    // Verify LLVM_PROFILE_FILE path
    let llvm_profile = result.iter()
        .find(|(k, _)| k == &OsString::from("LLVM_PROFILE_FILE"))
        .unwrap()
        .1
        .to_string_lossy()
        .to_string();
    assert!(llvm_profile.contains("/coverage/debug"));

    // Verify RUSTFLAGS contains instrumentation flags
    let rustflags = result.iter()
        .find(|(k, _)| k == &OsString::from("RUSTFLAGS"))
        .unwrap()
        .1
        .to_string_lossy()
        .to_string();
    assert!(rustflags.contains("-Zprofile"));
    assert!(rustflags.contains("-Ccodegen-units=1"));
}