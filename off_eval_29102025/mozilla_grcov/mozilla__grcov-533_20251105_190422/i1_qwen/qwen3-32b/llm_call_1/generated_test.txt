#[test]
fn test_get_coverage_env_vars_adds_expected_flags() {
    let mut env = HashMap::new();
    env.insert(OsString::from("CARGO_TARGET_DIR"), OsString::from("/my/target/dir"));

    let context = Context {
        env,
        pwd: PathBuf::from("/project/root"),
        args: vec![].into_iter().collect(),
    };

    let profile = "debug";

    let result = get_coverage_env_vars(&context.env, profile);

    // Check RUSTFLAGS
    let rustflags = &result.iter()
        .find(|(k, _)| k == &OsString::from("RUSTFLAGS"))
        .unwrap()
        .1;
    assert!(rustflags.to_string_lossy().contains("-Zprofile"));
    assert!(rustflags.to_string_lossy().contains("-Ccodegen-units=1"));

    // Check LLVM_PROFILE_FILE path
    let llvm_profile = result.iter()
        .find(|(k, _)| k == &OsString::from("LLVM_PROFILE_FILE"))
        .unwrap()
        .1;
    assert!(llvm_profile.to_string_lossy().contains("/my/target/coverage/debug/default.profraw"));
}