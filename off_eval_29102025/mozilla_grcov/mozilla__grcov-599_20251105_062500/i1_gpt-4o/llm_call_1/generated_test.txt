#[test]
fn test_output_cobertura_integration() {
    let tmp_dir = tempfile::tempdir().expect("Failed to create temporary directory");
    let file_name = "test_cobertura_integration.xml";
    let file_path = tmp_dir.path().join(&file_name);

    let results = vec![(
        PathBuf::from("src/main.rs"),
        PathBuf::from("src/main.rs"),
        CovResult {
            lines: [
                (1, 1),
                (2, 1),
                (3, 2),
                (4, 1),
                (5, 0),
                (6, 0),
                (8, 1),
                (9, 1),
            ]
            .iter()
            .cloned()
            .collect(),
            branches: {
                let mut map = BTreeMap::new();
                map.insert(3, vec![true, false]);
                map.insert(5, vec![false, false]);
                map
            },
            functions: {
                let mut map = FxHashMap::default();
                map.insert(
                    "_ZN8cov_test4main17h7eb435a3fb3e6f20E".to_string(),
                    Function {
                        start: 1,
                        executed: true,
                    },
                );
                map
            },
        },
    )];

    let results = Box::new(results.into_iter());
    output_cobertura(results, Some(file_path.to_str().unwrap()), true);

    let mut f = File::open(&file_path).expect("file not found");
    let mut results = String::new();
    f.read_to_string(&mut results).unwrap();

    assert!(results.contains(r#"package name="src/main.rs""#));
    assert!(results.contains(r#"class name="main" filename="src/main.rs""#));
    assert!(results.contains(r#"method name="cov_test::main""#));
    assert!(results.contains(r#"line number="1" hits="1">"#));
    assert!(results.contains(r#"line number="3" hits="2" branch="true""#));
    assert!(results.contains(r#"<condition number="0" type="jump" coverage="1"/>"#));

    assert!(results.contains(r#"lines-covered="6""#));
    assert!(results.contains(r#"lines-valid="8""#));
    assert!(results.contains(r#"line-rate="0.75""#));

    assert!(results.contains(r#"branches-covered="1""#));
    assert!(results.contains(r#"branches-valid="4""#));
    assert!(results.contains(r#"branch-rate="0.25""#));
}