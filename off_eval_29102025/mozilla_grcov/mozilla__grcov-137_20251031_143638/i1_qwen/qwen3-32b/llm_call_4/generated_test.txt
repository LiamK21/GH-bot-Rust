#[test]
fn test_llvm_gcno_detection() {
    let tmp_dir = tempdir().unwrap();
    let test_file_path = tmp_dir.path().join("test.gcno");
    let mut file = File::create(&test_file_path).unwrap();
    let magic: [u8; 8] = [b'o', b'n', b'c', b'g', b'*', b'2', b'0', b'4'];
    file.write_all(&magic).unwrap();

    let mut queue = WorkQueue::new();
    producer(tmp_dir.path(), &[test_file_path.to_string_lossy().to_string()], &queue, false, true);

    let work_items = queue.items.lock().unwrap();
    assert!(work_items.iter().any(|item| {
        item.format == ItemFormat::GCNO && item.name == "test"
    }), "Expected GCNO item with name 'test'");
    work_items.iter().for_each(|item| {
        if item.format == ItemFormat::GCNO {
            match &item.item {
                ItemType::Path(p) => assert!(p.ends_with("test"), "Path ends with 'test'"),
                ItemType::Buffers(b) => assert!(b.stem.ends_with("test"), "Buffers stem ends with 'test'"),
                _ => panic!("Unexpected ItemType"),
            }
        }
    });
}