#[test]
#[should_panic(expected = "gcov stderr: test stderr")]
fn test_gcov_failure_outputs_stderr() {
    let tmp_dir = env::temp_dir();
    let script_path = tmp_dir.join("temp_gcov_script.sh");
    let script_content = "#!/bin/sh\n\
                        echo 'test stdout'\n\
                        echo 'test stderr' >&2\n\
                        exit 1";
    fs::write(&script_path, script_content).unwrap();

    #[cfg(unix)]
    {
        use std::os::unix::fs::PermissionsExt;
        let mut perms = std::fs::metadata(&script_path)
            .unwrap()
            .permissions();
        perms.set_mode(0o755);
        fs::set_permissions(&script_path, perms).unwrap();
    }

    env::set_var("GCOV", script_path.to_str().unwrap());

    let dummy_gcno = PathBuf::from("/nonexistent.gcno");
    let dummy_dir = PathBuf::from("/nonexistent_dir");

    super::run_gcov(&dummy_gcno, false, &dummy_dir);
}