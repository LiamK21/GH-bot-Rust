#[test]
fn test_regression_symlink_handling() {
    let tempdir = TempDir::new("grcov_regression").unwrap();
    let source_dir = tempdir.path().to_path_buf();

    let storage_path = source_dir.join("storage");
    fs::create_dir_all(&storage_path).unwrap();
    let storage_file = storage_path.join("Variant_inl.h");
    fs::File::create(&storage_file).unwrap();

    let obj_dir = source_dir.join("obj-x86_64-pc-linux-gnu");
    fs::create_dir_all(&obj_dir).unwrap();
    let symlink_path = obj_dir
        .join("dist")
        .join("include")
        .join("mozilla")
        .join("storage")
        .join("Variant_inl.h");
    fs::create_dir_all(symlink_path.parent().unwrap()).unwrap();
    symlink(&storage_path.join("Variant_inl.h"), symlink_path).expect("Failed to create symlink");

    let result = panic::catch_unwind(|| {
        let result_map: CovResultMap = Default::default();
        rewrite_paths(
            result_map,
            None,
            Some(source_dir.clone()),
            None,
            false,
            Vec::new(),
            None,
        );
    });

    tempdir.close().unwrap();

    assert!(result.is_ok());
}