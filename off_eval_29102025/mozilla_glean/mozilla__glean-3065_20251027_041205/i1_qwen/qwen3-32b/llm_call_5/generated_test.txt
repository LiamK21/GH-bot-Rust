#[test]
fn test_ohttp_ping_platform_condition() {
    // Simulate non-desktop environment
    std::env::remove_var("CARGO_CFG_WINDOWS");
    std::env::remove_var("CARGO_CFG_LINUX");
    std::env::remove_var("CARGO_CFG_MACOS");
    std::env::set_var("CARGO_CFG_TARGET_OS", "android");

    let tmp_dir = Shell::new().unwrap().pushd_dir("ohttp_test").unwrap();
    let pings_yaml = tmp_dir.join("pings.yaml");
    fs::write(&pings_yaml, "pings:\n  my_ping:\n    type: ping\n    method: OHTTP").unwrap();

    let builder = Builder::new();
    builder.generate().unwrap();

    let generated_file = tmp_dir.join("glean/generated.rs");
    let code = fs::read_to_string(&generated_file).unwrap();

    // Test should fail before patch (parser 16.1.0) as condition is not present
    // Should pass after patch (parser 17.0.1) where condition is added
    assert!(code.contains("#[cfg(any(target_os = \"windows\","));
    assert!(code.contains("target_os = \"macos\","));
    assert!(code.contains("target_os = \"linux\""))));
    assert!(code.contains("pub struct MyPing"));
    assert!(code.contains("fn send") && code.contains("if cfg!(target_os"));
}