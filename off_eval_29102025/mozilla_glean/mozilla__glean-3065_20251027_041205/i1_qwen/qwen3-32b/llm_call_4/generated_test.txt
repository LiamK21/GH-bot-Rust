#[test]
fn test_ohttp_ping_generates_platform_restrictions() {
    // Simulate a non-desktop environment by unsetting desktop-specific flags
    std::env::remove_var("CARGO_CFG_WINDOWS");
    std::env::remove_var("CARGO_CFG_LINUX");
    std::env::remove_var("CARGO_CFG_MACOS");
    std::env::set_var("CARGO_CFG_TARGET_OS", "android");

    let tmp_dir = Shell::new().unwrap().pushd_dir("ohttp_test").unwrap();
    let pings_yaml = tmp_dir.join("pings.yaml");
    let mut pings_file = fs::File::create(&pings_yaml).unwrap();
    writeln!(
        pings_file,
        "pings:\n  my_pings:\n    type: ping\n    method: OHTTP"
    )
    .unwrap();
    let builder = Builder::new();
    builder.generate().unwrap();

    let generated_file = tmp_dir.join("glean/generated.rs");
    let code = fs::read_to_string(&generated_file).unwrap();

    // Expect generated code to include a platform-specific condition
    // This condition prevents the ping from being sent on non-desktop platforms
    // In older parser versions (before fix), this line would be absent
    assert!(code.contains("#[cfg(any(target_os = \"windows\", target_os = \"macos\", target_os = \"linux\"))]"));
}