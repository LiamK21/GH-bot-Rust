#[test]
fn maximum_wait_attempts_is_enforced() {
    let (mut glean, dir) = crate::test::new_glean(None);
    let mut manager = PingUploadManager::new(dir.path(), "Testing", true);
    manager.set_rate_limiter(5, 1);
    manager.enqueue_ping(&glean, &Uuid::new_v4().to_string(), "test", "", None);
    manager.enqueue_ping(&glean, &Uuid::new_v4().to_string(), "test", "", None);

    // Consume the first ping
    manager.get_upload_task(&glean, false);

    // Check we get MAX_WAIT_ATTEMPTS Wait responses
    for _ in 0..MAX_WAIT_ATTEMPTS {
        assert_eq!(manager.get_upload_task(&glean, false), PingUploadTask::Wait);
    }

    // After exceeding the max wait attempts, we should get Done
    assert_eq!(manager.get_upload_task(&glean, false), PingUploadTask::Done);

    // Wait for the rate limiter to reset
    thread::sleep(Duration::from_secs(5));

    // Should now be able to get a ping again
    assert!(matches!(manager.get_upload_task(&glean, false), PingUploadTask::Upload(_)));
    assert_eq!(manager.get_upload_task(&glean, false), PingUploadTask::Done);
}