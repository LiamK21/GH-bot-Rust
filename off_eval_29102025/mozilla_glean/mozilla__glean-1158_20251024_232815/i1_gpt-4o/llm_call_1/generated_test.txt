#[test]
fn test_maximum_wait_attempts_enforced() {
    let dir = tempfile::tempdir().unwrap();
    let glean = Arc::new(Glean::new(dir.path(), "Testing", false).unwrap());
    let mut upload_manager = PingUploadManager::new(dir.path(), "Testing", true);

    upload_manager.set_rate_limiter(5, 1);

    upload_manager.enqueue_ping(&glean, &Uuid::new_v4().to_string(), "", "", None);
    upload_manager.enqueue_ping(&glean, &Uuid::new_v4().to_string(), "", "", None);

    match upload_manager.get_upload_task(&glean, false) {
        PingUploadTask::Upload(_) => {}
        _ => panic!("Expected upload manager to return the next request!"),
    }

    for _ in 0..3 {
        assert_eq!(
            upload_manager.get_upload_task(&glean, false),
            PingUploadTask::Wait
        );
    }

    assert_eq!(
        upload_manager.get_upload_task(&glean, false),
        PingUploadTask::Done
    );

    thread::sleep(Duration::from_secs(5));

    match upload_manager.get_upload_task(&glean, false) {
        PingUploadTask::Upload(_) => {}
        _ => panic!("Expected upload manager to return the next request!"),
    }

    assert_eq!(
        upload_manager.get_upload_task(&glean, false),
        PingUploadTask::Done
    );
}