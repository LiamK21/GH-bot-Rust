#[test]
fn test_concurrent_pings_are_uploaded() {
  let dir = tempdir().unwrap();
  let upload_manager = PingUploadManager::new(dir.path());
  while upload_manager.get_upload_task() == PingUploadTask::Wait {
    thread::sleep(Duration::from_millis(10));
  }
  let doc1 = "684fa150-8dff-11ea-8faf-cb1ff3b11119";
  let path1 = format!("/submit/app_id/test-ping/1/{}", doc1);
  let doc2 = "74f14e9a-8dff-11ea-b45a-6f936923f639";
  let path2 = format!("/submit/app_id/test-ping/1/{}", doc2);
  upload_manager.enqueue_ping(doc1, &path1, json!({}));
  let req = match upload_manager.get_upload_task() {
    PingUploadTask::Upload(req) => req,
    _ => panic!("Expected upload manager to return the next request!"),
  };
  assert_eq!(doc1, req.document_id);
  upload_manager.enqueue_ping(doc2, &path2, json!({}));
  thread::sleep(Duration::from_millis(100));
  upload_manager.process_ping_upload_response(&req.document_id, HttpStatus(200));
  let req = match upload_manager.get_upload_task() {
    PingUploadTask::Upload(req) => req,
    _ => panic!("Expected upload manager to return the next request!"),
  };
  assert_eq!(doc2, req.document_id);
  upload_manager.process_ping_upload_response(&req.document_id, HttpStatus(200));
  match upload_manager.get_upload_task() {
    PingUploadTask::Done => {}
    _ => panic!("Expected upload manager to return the next request!"),
  }
  // Introduce a small delay to simulate concurrent submission
  thread::sleep(Duration::from_millis(10));
  let doc3 = "123e4567-e89b-12d3-a456-426655440000";
  let path3 = format!("/submit/app_id/test-ping/1/{}", doc3);
  upload_manager.enqueue_ping(doc3, &path3, json!({}));
  let req = match upload_manager.get_upload_task() {
    PingUploadTask::Upload(req) => req,
    _ => panic!("Expected upload manager to return the next request!"),
  };
  assert_eq!(doc3, req.document_id);
}