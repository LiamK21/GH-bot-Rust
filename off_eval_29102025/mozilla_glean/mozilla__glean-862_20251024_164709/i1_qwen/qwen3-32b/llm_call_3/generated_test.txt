#[test]
fn test_concurrent_ping_submission() {
    let dir = tempfile::tempdir().unwrap();
    let upload_manager = PingUploadManager::new(dir.path());
    while upload_manager.get_upload_task() == PingUploadTask::Wait {
        std::thread::sleep(std::time::Duration::from_millis(10));
    }

    let doc1 = "684fa150-8dff-11ea-8faf-cb1ff3b11119";
    let path1 = format!("/submit/app_id/test-ping/1/{}", doc1);
    let doc2 = "74f14e9a-8dff-11ea-b45a-6f936923f639";
    let path2 = format!("/submit/app_id/test-ping/1/{}", doc2);

    upload_manager.enqueue_ping(doc1, &path1, json!({}));
    let req1 = match upload_manager.get_upload_task() {
        PingUploadTask::Upload(req) => req,
        _ => panic!("First ping not enqueued"),
    };
    assert_eq!(doc1, req1.document_id);

    // Manually create the second ping in the pending directory as an actual file.
    let pending_dir = dir.path().join("pending");
    fs::create_dir_all(&pending_dir).unwrap();
    let doc2_pending_path = pending_dir.join(doc2);
    let mut file = fs::File::create(doc2_pending_path).unwrap();
    file.write_all(br#"{"ping": "data"}"#).unwrap();

    // Process the first ping
    upload_manager.process_ping_upload_response(&req1.document_id, HttpStatus(200));

    // Now the second ping should be picked up.
    let req2 = match upload_manager.get_upload_task() {
        PingUploadTask::Upload(req) => req,
        _ => panic!("Second ping not found after processing first"),
    };
    assert_eq!(doc2, req2.document_id);

    upload_manager.process_ping_upload_response(&req2.document_id, HttpStatus(200));
    assert!(matches!(upload_manager.get_upload_task(), PingUploadTask::Done));
}