#[test]
fn test_iterate_metric_id_consistency() {
    let temp_dir = tempdir().unwrap();
    let db = Database::_open(temp_dir.path()).unwrap();

    let metric_id = "category.name";
    let value = Metric::String("test_value".to_string());

    let metric_data = CommonMetricData {
        metric_id: metric_id.to_string(),
        ..Default::default()
    };

    db._db_write(Lifetime::Application, |writer| {
        db.put_metric(&writer, "storage", &metric_data, value.clone(), false).unwrap();
    })
    .unwrap();

    let found_id = RwLock::new(None);
    db.iterate(Lifetime::Application, "storage", move |id_bytes, _| {
        let id = String::from_utf8_lossy(id_bytes).into_owned();
        *found_id.write().unwrap() = Some(id);
    })
    .unwrap();

    assert_eq!(*found_id.into_inner().unwrap().unwrap(), metric_id);
}