#[test]
fn test_metric_id_consistency() {
    let temp_dir = std::env::temp_dir();
    let db = crate::database::Database::new(temp_dir, "application_id".to_string()).unwrap();

    let common = CommonMetricData {
        category: "category".to_string(),
        name: "name".to_string(),
        ..Default::default()
    };
    let metric_id = "category.name";

    let metric = TestMetric {
        ty: MetricType::String,
        ..Default::default()
    };

    metric
        .lock()
        .unwrap()
        .set(String::from("test_value"), false)
        .unwrap();

    db.store_metric(&common, &metric, Lifetime::Application, false)
        .unwrap();

    let snapshot = StorageManager::take_snapshot(Lifetime::Application, "store", true);
    let mut result = None;

    snapshot.map(|s| {
        result = s.get(metric_id).cloned();
    });

    assert_eq!(result.as_ref().unwrap().as_string().unwrap(), "test_value");
}