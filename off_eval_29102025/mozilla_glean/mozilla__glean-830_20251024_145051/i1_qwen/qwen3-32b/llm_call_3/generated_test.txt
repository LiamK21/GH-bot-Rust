#[test]
fn test_iterate_metric_id_consistency() {
    let temp_dir = tempfile::tempdir().expect("Failed to create temp dir");
    let db = Database::new(temp_dir.path().to_str().unwrap(), false).unwrap();

    let metric_id = "category.name";
    let metric_data = CommonMetricData {
        category: "category".to_string(),
        name: "name".to_string(),
        ..Default::default()
    };
    let value = Metric::String("test_value".to_string());

    db._db_write(Lifetime::Application, |writer| {
        db.put_metric(writer, "storage", &metric_data, value.clone(), false).unwrap();
    })
    .unwrap();

    let found_id = RwLock::new(None);
    db.iterate(Lifetime::Application, "storage", move |id_bytes, _| {
        let id = String::from_utf8_lossy(id_bytes).into_owned();
        *found_id.write().unwrap() = Some(id);
    })
    .unwrap();

    assert_eq!(*found_id.into_inner().unwrap().unwrap(), metric_id);
}