#[test]
fn test_experiments_extra_limits() {
  let mut extra = HashMap::new();
  let too_long_key = "0123456789".repeat(5);
  let too_long_value = "0123456789".repeat(6);
  for n in 0..21 {
    extra.insert(format!("{}-{}", n, too_long_key), too_long_value.clone());
  }
  let experiment_id = "test-experiment_id".to_string();
  let branch_id = "test-branch-id".to_string();
  let experiment = ExperimentMetric::new(experiment_id.clone());
  let value = Metric::Experiment(RecordedExperimentData {
    branch: branch_id,
    extra: Some(extra),
  });
  let glean = Glean::with_options("test", "org.mozilla.glean.tests", true).unwrap();
  glean.storage().record(&experiment.meta, &value);
  let experiment_data = glean.test_get_experiment_data_as_json(experiment_id);
  assert!(
    !experiment_data.is_none(),
    "Experiment data must be available"
  );
  let parsed_json: RecordedExperimentData =
    serde_json::from_str(&experiment_data.unwrap()).unwrap();
  assert_eq!(
    20,
    parsed_json.clone().extra.unwrap().len(),
    "Experiments extra must be less than max length"
  );
  for (key, value) in parsed_json.extra.as_ref().unwrap().iter() {
    assert!(
      key.len() <= 30,
      "Experiments extra key must be less than max length"
    );
    assert!(
      value.len() <= 50,
      "Experiments extra value must be less than max length"
    );
  }
}