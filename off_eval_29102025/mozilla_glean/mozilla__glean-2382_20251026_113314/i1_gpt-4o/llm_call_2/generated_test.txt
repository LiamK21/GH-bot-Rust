#[test]
fn test_missing_send_ids_increments_counter() {
    let glean = Glean::new(Default::default()).unwrap();
    let upload_metrics = UploadMetrics {
        send_success: TimingDistributionMetric::new(CommonMetricData::default()),
        send_failure: TimingDistributionMetric::new(CommonMetricData::default()),
        in_flight_pings_dropped: CounterMetric::new(CommonMetricData::default()),
        missing_send_ids: CounterMetric::new(CommonMetricData {
            name: "missing_send_ids".into(),
            category: "glean.upload".into(),
            send_in_pings: vec!["metrics".into()],
            lifetime: Lifetime::Ping,
            disabled: false,
            dynamic_label: None,
        }),
        deleted_pings_after_quota_hit: CounterMetric::new(CommonMetricData::default()),
        discarded_exceeding_pings_size: CounterMetric::new(CommonMetricData::default()),
        pending_pings: CounterMetric::new(CommonMetricData::default()),
    };
    let mut ping_upload_manager = PingUploadManager {
        upload_metrics,
        cached_pings: HashMap::new(),
        directory_manager: Default::default(),
        in_flight: HashMap::new(),
        upload_task: None,
        upload_task_handle: None,
        upload_task_shutdown: None,
        upload_task_shutdown_complete: None,
    };
    let document_id = "test_doc_id";
    let status = crate::upload::UploadResult::HttpStatus { code: 404 };
    let mut lock = HashMap::new();

    ping_upload_manager.handle_upload_status(&glean, document_id, status, &mut lock);

    let expected = Some(1);
    let actual = ping_upload_manager.upload_metrics.missing_send_ids.test_get_value(Some("metrics".into()));
    assert_eq!(expected, actual);
}