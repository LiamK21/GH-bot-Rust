#[test]
fn test_first_run_sets_last_sent_build() {
    let (mut glean, _t) = new_glean(None);
    glean.app_build = "initial_build".into();
    let lsb_metric = get_last_sent_build_metric();
    assert_eq!(None, lsb_metric.get_value(&glean, Some(INTERNAL_STORAGE)));

    let fake_now = FixedOffset::east(0)
                        .ymd(2022, 11, 15)
                        .and_hms(SCHEDULED_HOUR, 0, 1);

    let expected_count_before = 0;
    let expected_count_after = 1;

    // Mock submitter and scheduler to capture when they're called
    let submitter = Box::new(|_, _| {});
    let scheduler = Box::new(|_, _| {});

    let (submitter_count, scheduler_count) = (AtomicUsize::new(0), AtomicUsize::new(0));

    schedule_internal(&glean, submitter, scheduler, fake_now);

    assert_eq!(some_expected_value, submitter_count.load(Ordering::Relaxed));
    assert_eq!(some_expected_value, scheduler_count.load(Ordering::Relaxed));

    assert_eq!(
        Some(glean.app_build.to_string()),
        lsb_metric.get_value(&glean, Some(INTERNAL_STORAGE))
    );
}