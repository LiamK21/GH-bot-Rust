#[test]
fn test_first_run_sets_last_sent_build() {
    let (mut glean, _t) = new_glean(None);
    glean.app_build = "initial_build".into();
    let lsb_metric = get_last_sent_build_metric();
    assert_eq!(None, lsb_metric.get_value(&glean, Some(INTERNAL_STORAGE)));

    let fake_now = FixedOffset::east(0)
        .ymd(2022, 11, 15)
        .and_hms(SCHEDULED_HOUR, 0, 1);

    let submitter_count = AtomicUsize::new(0);
    let scheduler_count = AtomicUsize::new(0);

    let submitter = Box::new(|_, _| {
        submitter_count.fetch_add(1, Ordering::Relaxed);
    });
    let scheduler = Box::new(|_, _| {
        scheduler_count.fetch_add(1, Ordering::Relaxed);
    });

    schedule_internal(&glean, submitter, scheduler, fake_now);

    assert_eq!(1, submitter_count.load(Ordering::Relaxed));
    assert_eq!(1, scheduler_count.load(Ordering::Relaxed));

    assert_eq!(
        Some(glean.app_build.to_string()),
        lsb_metric.get_value(&glean, Some(INTERNAL_STORAGE))
    );
}