#[test]
fn test_clear_dirty_bit_on_shutdown() {
    let _lock = lock_test();

    let data_dir = initialize(None, true);
    block_on_dispatcher();

    with_glean_mut(|glean| glean.set_dirty_flag(true));

    shutdown();

    let (s, r) = bounded::<String>(1);

    #[derive(Debug)]
    pub struct FakeUploader {
        sender: crossbeam_channel::Sender<String>,
    }
    impl net::PingUploader for FakeUploader {
        fn upload(
            &self,
            url: String,
            _body: Vec<u8>,
            _headers: Vec<(String, String)>,
        ) -> net::UploadResult {
            self.sender.send(url).unwrap();
            net::UploadResult::HttpStatus(200)
        }
    }

    let tmpname = data_dir.path().display().to_string();

    test_reset_glean(
        Configuration {
            data_path: tmpname,
            application_id: GLOBAL_APPLICATION_ID.into(),
            upload_enabled: true,
            max_events: None,
            delay_ping_lifetime_io: false,
            channel: Some("testing".into()),
            server_endpoint: Some("invalid-test-host".into()),
            uploader: Some(Box::new(FakeUploader { sender: s })),
        },
        ClientInfoMetrics::unknown(),
        false,
    );

    block_on_dispatcher();

    assert_eq!(r.try_recv(), Err(TryRecvError::Empty));
}