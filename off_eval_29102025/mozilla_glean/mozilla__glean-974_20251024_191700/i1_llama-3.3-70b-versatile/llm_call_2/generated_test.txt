#[test]
fn test_rate_limiter_prevents_excessive_pings() {
  // Create a new upload_manager
  let mut upload_manager = PingUploadManager::new("/tmp", false);

  // Add a rate limiter to the upload mangager with max of 10 pings every 3 seconds.
  let secs_per_interval = 3;
  let max_pings_per_interval = 10;
  upload_manager.set_rate_limiter(secs_per_interval, max_pings_per_interval);

  // Enqueue a ping multiple times
  for _ in 0..max_pings_per_interval + 1 {
    upload_manager.enqueue_ping(DOCUMENT_ID, PATH, json!({}));
  }

  // Verify that we are indeed told to wait because we are at capacity
  assert_eq!(PingUploadTask::Wait, upload_manager.get_upload_task(false));

  // Verify that after the rate limit interval, we can get another ping
  thread::sleep(Duration::from_secs(secs_per_interval));
  assert_ne!(PingUploadTask::Wait, upload_manager.get_upload_task(false));
}