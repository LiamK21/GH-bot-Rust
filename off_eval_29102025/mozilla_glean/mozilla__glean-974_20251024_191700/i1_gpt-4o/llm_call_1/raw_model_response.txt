<Filename>glean-core/src/upload/mod.rs</Filename>
<imports>
use super::PingUploadManager;
use super::PingUploadTask;
use serde_json::json;
use std::thread;
use std::time::Duration;
</imports>
<Rust>
#[test]
fn test_rate_limiting_of_ping_uploads() {
    let dir = tempfile::tempdir().unwrap();
    let mut upload_manager = PingUploadManager::new(dir.path(), false);

    let secs_per_interval = 60;
    let max_pings_per_interval = 10;
    upload_manager.set_rate_limiter(secs_per_interval, max_pings_per_interval);

    while upload_manager.get_upload_task(false) == PingUploadTask::Wait {
        thread::sleep(Duration::from_millis(10));
    }

    for _ in 0..max_pings_per_interval {
        upload_manager.enqueue_ping("document_id", "path", json!({}));
    }

    for _ in 0..max_pings_per_interval {
        match upload_manager.get_upload_task(false) {
            PingUploadTask::Upload(_) => {}
            _ => panic!("Expected upload manager to return the next request!"),
        }
    }

    upload_manager.enqueue_ping("document_id", "path", json!({}));

    assert_eq!(PingUploadTask::Wait, upload_manager.get_upload_task(false));

    thread::sleep(Duration::from_secs(secs_per_interval));

    match upload_manager.get_upload_task(false) {
        PingUploadTask::Upload(_) => {}
        _ => panic!("Expected upload manager to return the next request!"),
    }
}
</Rust>