<Filename>glean-core/src/upload/mod.rs</Filename>
<imports>
use std::fs;
use std::path::PathBuf;
use crate::directory::PingDirectoryManager;
use crate::internal_metrics::UploadMetrics;
use crate::Glean;
use tempfile::tempdir;
use crate::Configuration;
use crate::error::Error;
use crate::upload::PingUploadManager;
use crate::upload::PingUploadTask;
use crate::upload::PingRequest;
use crate::upload::HeaderMap;
use crate::ping::PingType;
use crate::ping::PingTypeBuilder;
use crate::ping::PingData;
use crate::ping::PingInfo;
use super::process_metadata;
</imports>
<Rust>
#[test]
fn test_pending_pings_directory_size_is_calculated_and_quota_is_enforced() {
  let tmpdir = tempdir().unwrap();
  let mut glean = Glean::new(Configuration { data_path: tmpdir.path().to_path_buf(), ..Default::default() }).unwrap();
  let ping_type = PingType::new("test", true, true, vec![]);
  glean.register_ping_type(&ping_type);
  for _ in 0..100 {
    glean.submit_ping(&ping_type, None).unwrap();
  }
  let directory_manager = PingDirectoryManager::new(tmpdir.path());
  let upload_manager = PingUploadManager::new(tmpdir.path(), "Rust", true);
  upload_manager.enqueue_cached_pings(&glean, 500);
  let pending_pings_directory_size = upload_manager.upload_metrics.pending_pings_directory_size.test_get_value(&glean, "metrics").unwrap();
  let deleted_pings_after_quota_hit = upload_manager.upload_metrics.deleted_pings_after_quota_hit.test_get_value(&glean, "metrics").unwrap();
  assert!(pending_pings_directory_size > 0);
  assert_eq!(deleted_pings_after_quota_hit, 99);
}
</Rust>