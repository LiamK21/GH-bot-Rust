#[test]
fn test_pending_pings_directory_size_is_recorded() {
    let (mut glean, tmpdir) = new_glean(None);
    let ping_type = PingType::new("test", true, /* send_if_empty */ true, vec![]);
    glean.register_ping_type(&ping_type);

    // Submit the ping twice
    for _ in 0..2 {
        glean.submit_ping(&ping_type, None).unwrap();
    }

    // Get the ping file paths and adjust sizes
    let manager = PingDirectoryManager::new(tmpdir.path());
    let pings = manager.process_dirs().pending_pings;
    assert_eq!(pings.len(), 2);

    // Adjust file sizes to exactly 1 KiB and 2 KiB
    for (i, (_, (doc_id, path_str, _, _))) in pings.iter().enumerate() {
        let path = Path::new(path_str);
        let mut file = fs::File::create(path).unwrap();
        let size_bytes = if i == 0 { 1024 } else { 2048 };
        let bytes = vec![b'a'; size_bytes as usize];
        file.write_all(&bytes).unwrap();
    }

    // Create the upload manager
    let upload_manager = PingUploadManager::new(tmpdir.path(), "Rust", true);
    // Use a quota larger than the total size to avoid deletions
    upload_manager.enqueue_cached_pings(&glean, 10_000_000); // 10 MiB

    // Check the metric recorded the correct size (3 KiB)
    let metric_value = upload_manager.upload_metrics
        .pending_pings_directory_size
        .test_get_value(&glean, "metrics")
        .unwrap();

    // The sample should be 3 KiB (3072 bytes)
    assert_eq!(metric_value, "{\"sum\":3}");
}