<Filename>glean-core/src/upload/mod.rs</Filename>
<imports>
use super::PingUploadManager;
use crate::Glean;
use crate::PingType;
use crate::upload::PingUploadTask;
use std::time::Duration;
use std::thread;
</imports>
<Rust>
#[test]
fn test_quota_is_enforced_when_enqueueing_cached_pings() {
    let (mut glean, tmpdir) = new_glean(None);

    let ping_type = PingType::new("test", true, true, vec![]);
    glean.register_ping_type(&ping_type);

    let n = 10;
    for _ in 0..n {
        glean.submit_ping(&ping_type, None).unwrap();
    }

    let directory_manager = PingDirectoryManager::new(tmpdir.path());
    let pending_pings = directory_manager.process_dirs().pending_pings;
    let (_, newest_ping) = &pending_pings.last().unwrap();
    let (newest_ping_id, _, _, _) = &newest_ping;

    let upload_manager = PingUploadManager::new(tmpdir.path(), "Rust", true);

    upload_manager.enqueue_cached_pings(&glean, 500);

    match upload_manager.get_upload_task(&glean, false) {
        PingUploadTask::Upload(request) => assert_eq!(&request.document_id, newest_ping_id),
        _ => panic!("Expected upload manager to return the next request!"),
    }

    assert_eq!(
        upload_manager.get_upload_task(&glean, false),
        PingUploadTask::Done
    );

    assert_eq!(
        n - 1,
        upload_manager
            .upload_metrics
            .deleted_pings_after_quota_hit
            .test_get_value(&glean, "metrics")
            .unwrap()
    )
}
</Rust>