<Filename>glean-core/src/upload/mod.rs</Filename>
<imports>
use std::sync::Arc;
use std::thread;
use std::time::Duration;
use super::PingUploadManager;
use super::PingUploadTask;
use super::PingRequest;
use std::fs;
use std::io::prelude::*;
use uuid::Uuid;
</imports>
<Rust>
#[test]
fn test_process_ping_upload_response_re_enqueues_on_server_error() {
  let dir = std::path::Path::new("/tmp");
  let _ = fs::create_dir_all(dir.join("pending_pings"));
  let directory_manager = PingDirectoryManager::new("/tmp");
  let upload_manager = PingUploadManager::new("/tmp");
  let uuid = Uuid::new_v4().to_string();
  let mut file = fs::File::create(dir.join("pending_pings").join(&uuid)).unwrap();
  file.write_all(b"https://example.com\n{\n}\n").unwrap();
  upload_manager.process_ping_upload_response(&uuid, 500);
  let mut upload_task = upload_manager.get_upload_task();
  while upload_task == PingUploadTask::Wait {
      thread::sleep(Duration::from_millis(10));
      upload_task = upload_manager.get_upload_task();
  }
  match upload_task {
      PingUploadTask::Upload(request) => {
          assert_eq!(request.uuid, uuid);
      }
      _ => panic!("Expected upload manager to return the next request!"),
  }
}
</Rust>