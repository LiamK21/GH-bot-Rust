#[test]
fn test_label_cache_prevents_multiple_insertions() {
    static GLOBAL_LABELED: OnceCell<LabeledMetric<CounterMetric>> = OnceCell::new();
    static GLOBAL_HANDLE: u64 = 1;

    let common_data = CommonMetricData {
        category: "test".into(),
        name: "label_counter".into(),
        send_in_pings: vec![],
        ..Default::default()
    };
    let counter_metric = CounterMetric::new(common_data);
    let labeled_metric = LabeledMetric::new(counter_metric, None);

    GLOBAL_LABELED.set(labeled_metric).unwrap();

    let label = "test_label";
    let ffi_label = ffi_support::FfiStr::from(label);

    unsafe {
        let first = glean_labeled_counter_metric_get(GLOBAL_HANDLE, ffi_label);
        let second = glean_labeled_counter_metric_get(GLOBAL_HANDLE, ffi_label);
        assert_eq!(first, second);
    }
}