#[test]
fn test_shutdown_blocks_until_preinit_flushed() {
    let init_complete = Arc::new(AtomicBool::new(false));
    let init_clone = init_complete.clone();

    let handle = std::thread::spawn(move || {
        let mut config = InternalConfiguration::default();
        config.uploads_enabled = false;
        initialize_inner(
            config,
            ClientInfoMetrics::default(),
            Box::new(|_, _| {})
        );
        init_clone.store(true, Ordering::Relaxed);
    });

    // Give init time to start but not finish
    std::thread::sleep(Duration::from_millis(10));

    // Global glean should still be None during shutdown
    shutdown();

    // Wait for init to complete to clean up
    handle.join().unwrap();

    // Without the patch, shutdown would skip waiting for preinit
    // With the patch, the delay would ensure we hit the timeout path
    assert!(!init_complete.load(Ordering::Relaxed));
}