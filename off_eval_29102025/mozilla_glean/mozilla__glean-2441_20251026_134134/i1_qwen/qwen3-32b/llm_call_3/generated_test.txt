#[test]
fn test_upload_triggered_on_max_events() {
    static STATE: OnceCell<Mutex<StateMock>> = OnceCell::new();

    struct StateMock {
        upload_counter: Cell<u8>,
    }

    impl StateMock {
        fn new() -> Self {
            Self {
                upload_counter: Cell::new(0),
            }
        }

        fn callbacks(&self) -> &dyn Callbacks {
            self
        }
    }

    impl Callbacks for StateMock {
        fn trigger_upload(&self) -> Result<(), ()> {
            self.upload_counter.set(self.upload_counter.get() + 1);
            Ok(())
        }
    }

    STATE.set(Mutex::new(StateMock::new())).unwrap();

    let glean = Glean::new(true).unwrap();

    let metric = EventMetric::new(crate::CommonMetricData {
        name: "test_event".into(),
        category: "test".into(),
        send_in_pings: vec!["events".into()],
        dynamic_children_send_in_pings: Vec::new(),
        disabled: false,
        lifetime: crate::Lifetime::Application,
        max_events: Some(1),
        allowed_extra_keys: None,
    });

    metric.record_with_time(0, HashMap::new());

    metric.record_with_time(1, HashMap::new());

    let state = STATE.get().unwrap().lock().unwrap();
    assert_eq!(state.upload_counter.get(), 1);
}