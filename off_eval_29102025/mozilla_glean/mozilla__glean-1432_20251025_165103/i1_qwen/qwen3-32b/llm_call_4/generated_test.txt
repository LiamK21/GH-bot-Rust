#[test]
fn test_core_metrics_cleared_after_reset() {
    let _lock = lock_test();
    let tmpdir = tempdir().unwrap();
    let tmpname = tmpdir.path().display().to_string();

    // First configuration
    let config1 = Configuration {
        data_path: tmpname.clone(),
        application_id: "test_app".into(),
        upload_enabled: true,
        server_endpoint: Some("https://example.com/upload".into()),
        max_events: None,
        delay_ping_lifetime_io: false,
        channel: None,
        uploader: None,
    };

    // Initialize Glean with config1
    test_reset_glean(config1.clone(), ClientInfoMetrics::unknown(), true);
    let glean = new_glean(Some(config1.clone()), true);

    // Set app_channel value
    app_channel::set_sync(&glean, "test_value");
    assert_eq!(Some("test_value".to_string()), app_channel::test_get_value(None));

    // Second configuration (same as first) for reset
    let config2 = Configuration {
        data_path: tmpname.clone(),
        application_id: "test_app".into(),
        upload_enabled: true,
        server_endpoint: Some("https://example.com/upload".into()),
        max_events: None,
        delay_ping_lifetime_io: false,
        channel: None,
        uploader: None,
    };

    // Reset Glean state
    test_reset_glean(config2, ClientInfoMetrics::unknown(), false);

    // Verify app_channel is cleared
    assert!(app_channel::test_get_value(None).is_none());
}