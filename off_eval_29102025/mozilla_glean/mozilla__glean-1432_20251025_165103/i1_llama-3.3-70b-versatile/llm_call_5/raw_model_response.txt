<Filename>glean-core/rlb/src/test.rs</Filename>
<imports>
use super::test_reset_glean;
use super::Configuration;
use super::ClientInfoMetrics;
use super::core_metrics;
use super::new_glean;
use super::set_upload_enabled;
use super::private::StringMetric;
use super::Lifetime;
use super::CommonMetricData;
use std::sync::Once;
use tempfile::tempdir;
use crossbeam_channel::bounded;
use glean_core::Glean;
use glean_core::Error;
use glean_core::Configuration as GleanConfiguration;
</imports>
<Rust>
#[test]
fn test_reset_glean_clears_core_metrics() {
  let _lock = std::sync::Once::new();
  let dir = tempdir().unwrap();
  let tmpname = dir.path().display().to_string();
  let cfg = Configuration {
    data_path: tmpname.clone(),
    application_id: "test".into(),
    upload_enabled: true,
    max_events: None,
    delay_ping_lifetime_io: false,
    channel: None,
    server_endpoint: Some("invalid-test-host".into()),
    uploader: None,
  };
  let _t = new_glean(Some(cfg), true);
  let metric = StringMetric::new(CommonMetricData {
    name: "string_metric".into(),
    category: "telemetry".into(),
    send_in_pings: vec!["default".into()],
    lifetime: Lifetime::Ping,
    disabled: false,
    ..Default::default()
  });
  metric.set("some value");
  assert!(metric.test_get_value(None).is_some());
  let glean_cfg = GleanConfiguration {
    data_path: tmpname,
    application_id: "test".into(),
    upload_enabled: true,
    max_events: None,
    delay_ping_lifetime_io: false,
    channel: None,
    server_endpoint: Some("invalid-test-host".into()),
    uploader: None,
  };
  let glean = Glean::new(glean_cfg).unwrap();
  core_metrics::internal_metrics::os_version.set_sync(&glean, "some value");
  assert!(core_metrics::internal_metrics::os_version.test_get_value(None).is_some());
  test_reset_glean(
    Configuration {
      data_path: tmpname,
      application_id: "test".into(),
      upload_enabled: true,
      max_events: None,
      delay_ping_lifetime_io: false,
      channel: None,
      server_endpoint: Some("invalid-test-host".into()),
      uploader: None,
    },
    ClientInfoMetrics::unknown(),
    true,
  );
  assert!(metric.test_get_value(None).is_none());
  assert!(core_metrics::internal_metrics::os_version.test_get_value(None).is_none());
}
</Rust>