#[test]
fn async_ping_directories_scanning_works() {
    let (glean, dir) = new_glean(None);

    // Create a new upload_manager with asynchronous ping dir scan
    let upload_manager = PingUploadManager::no_policy(dir.path(), /* sync_scan */ false);

    // Enqueue a single ping
    let ping_type = PingType::new("test", true, /* send_if_empty */ true, vec![]);
    glean.register_ping_type(&ping_type);
    glean.submit_ping(&ping_type, None).unwrap();

    // Wait for async scan to complete by checking for non-Wait task
    let mut task;
    loop {
        task = upload_manager.get_upload_task(&glean, false);
        if task != PingUploadTask::Wait {
            break;
        }
        sleep(Duration::from_millis(10));
    }

    // At this point, the async scan should have completed, and the ping should be enqueued.
    // Verify that the task is not `Done` yet, as we have a pending ping to upload.
    assert_ne!(task, Done);
}