#[test]
fn async_ping_scanning_sets_upload_task() {
    let (mut glean, dir) = new_glean(None);

    // Create a new upload manager with asynchronous ping directory scanning
    let upload_manager = PingUploadManager::no_policy(dir.path(), /* sync_scan */ false);

    // Register and submit a test ping
    let ping_type = crate::PingType::new("test", true, /* send_if_empty */ true, vec![]);
    glean.register_ping_type(&ping_type);
    glean.submit_ping(&ping_type, None).unwrap();

    // Wait for the async scan to process the ping
    let mut task;
    loop {
        task = upload_manager.get_upload_task(&glean, false);
        if task != PingUploadTask::Wait {
            break;
        }
        sleep(std::time::Duration::from_millis(10));
    }

    // Verify the task is not `Done` (there's a ping to upload)
    assert_ne!(task, PingUploadTask::Done);
}