<Filename>glean-core/src/database/mod.rs</Filename>
<imports>
use std::path::Path;
use rkv::Rkv;
use rkv::backend::Lmdb;
use rkv::backend::SafeMode;
use rkv::migrator::Migrator;
use rkv::StoreError;
use rkv::MigrateError;
use tempdir::TempDir;
use std::fs;
use super::migrate;
use super::rkv_new;
</imports>
<Rust>
#[test]
fn test_migration_from_lmdb_to_safe_mode() {
  let dir = TempDir::new("test").unwrap();
  let path = dir.path().join("db");
  fs::create_dir_all(&path).expect("create dir");
  let rkv_db = rkv_new(&path).expect("rkv env");
  let store = rkv_db.open_single("ping", rkv::StoreOptions::create()).expect("opened");
  let mut writer = rkv_db.write().expect("writer");
  store.put(&mut writer, "key", &rkv::Value::Blob(b"value")).expect("wrote");
  writer.commit().expect("committed");
  assert!(path.join("data.mdb").exists());
  assert!(path.join("lock.mdb").exists());
  let safe_rkv_db = rkv_new(&path).expect("rkv env");
  migrate(&path, &safe_rkv_db);
  assert!(!path.join("data.mdb").exists());
  assert!(!path.join("lock.mdb").exists());
  assert!(path.join("data.safe.bin").exists());
}
</Rust>