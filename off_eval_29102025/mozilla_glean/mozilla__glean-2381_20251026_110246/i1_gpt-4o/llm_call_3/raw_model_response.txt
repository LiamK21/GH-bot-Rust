<Filename>glean-core/src/upload/mod.rs</Filename>
<imports>
use super::PingUploadManager;
use crate::internal_metrics::UploadMetrics;
use crate::Glean;
use std::sync::{Arc, RwLock};
use std::collections::{HashMap, VecDeque};
use crate::metrics::CounterMetric;
use crate::core::InternalConfiguration;
use crate::metrics::timing_distribution::TimerId;
use std::sync::atomic::AtomicU32;
use crate::upload::request::PingRequest;
use crate::upload::directory::PingDirectoryManager;
use crate::upload::PingPayloadsByDirectory;
</imports>
<Rust>
#[test]
fn test_in_flight_pings_dropped_metric() {
    let glean = Arc::new(Glean::new(InternalConfiguration::default()).unwrap());
    let upload_metrics = UploadMetrics::new();
    let manager = PingUploadManager {
        upload_metrics,
        queue: RwLock::new(VecDeque::new()),
        directory_manager: PingDirectoryManager::new(),
        processed_pending_pings: Arc::new(AtomicU32::new(0)),
        cached_pings: Arc::new(RwLock::new(PingPayloadsByDirectory::new())),
        recoverable_failure_count: AtomicU32::new(0),
        in_flight: RwLock::new(HashMap::new()),
        wait_attempt_count: 0,
        rate_limiter: None,
        language_binding_name: None,
        policy: None,
    };

    let document_id = "test_doc_id".to_string();
    let path = "test_path".to_string();

    manager.in_flight.write().unwrap().insert(document_id.clone(), (TimerId::new(), TimerId::new()));

    manager.handle_ping_upload(glean.clone(), document_id, path);

    let expected = Some(1);
    let actual = manager.upload_metrics.in_flight_pings_dropped.test_get_value(Some("metrics".into()));
    assert_eq!(expected, actual);
}
</Rust>