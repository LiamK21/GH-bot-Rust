#[test]
fn test_recoverable_failure_logs_info_level() {
    struct TestLogger {
        last_level: Option<Level>,
        last_message: Option<String>,
    }

    impl TestLogger {
        fn new() -> Self {
            Self { last_level: None, last_message: None }
        }

        fn assert(&self, level: Level, msg: &str) {
            assert_eq!(self.last_level, Some(level));
            assert!(self.last_message.as_ref().unwrap().contains(msg));
        }
    }

    impl log::Log for TestLogger {
        fn enabled(&self, _: &log::Metadata) -> bool {
            true
        }

        fn log(&self, record: &log::Record) {
            self.last_level = Some(record.metadata().level());
            self.last_message = Some(record.args().to_string());
        }

        fn flush(&self) {}
    }

    let temp_dir = TempDir::new("glean-test").unwrap();
    let data_path = temp_dir.path().to_path_buf();

    // Set up the custom logger
    log::set_max_level(log::LevelFilter::Info);
    let logger = TestLogger::new();
    log::set_boxed_logger(Box::new(logger.clone())).unwrap();

    let manager = PingUploadManager::new(data_path, "test-frontend");

    let response = Response::builder()
        .status(StatusCode::TOO_MANY_REQUESTS)
        .body(vec![])
        .unwrap();

    let document_id = "test_document_id";
    block_on(manager.upload(document_id, &response));

    logger.assert(
        Level::Info,
        &format!("Recoverable upload failure while attempting to send ping {}, will retry. Error was HttpStatus(429)", document_id)
    );
}