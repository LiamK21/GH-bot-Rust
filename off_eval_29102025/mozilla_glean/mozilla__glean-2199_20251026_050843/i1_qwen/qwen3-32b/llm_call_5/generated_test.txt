#[test]
fn test_url_max_length_truncation() {
    let metric = UrlMetric::new(CommonMetricData {
        category: "test_category".to_string(),
        name: "test_url".to_string(),
        send_in_pings: vec!["store1".to_string()],
        ..Default::default()
    });
    let mut glean = Glean::new(InternalConfiguration {
        data_path: PathBuf::from("/tmp/glean-test"),
        application_id: "test-app".to_string(),
        language_binding_name: "rust".to_string(),
        upload_enabled: true,
        ..Default::default()
    })
    .unwrap();
    let long_url = "a".repeat(8192 + 1); // 1 character past the new limit
    metric.set_sync(&glean, &long_url);
    let stored = metric.get_value(&glean, "store1").unwrap();
    assert_eq!(stored.len(), 8192, "Expected URL truncation to MAX_URL_LENGTH");
    assert_eq!(
        test_get_num_recorded_errors(&glean, metric.meta(), ErrorType::InvalidOverflow).unwrap(),
        1,
        "Should have recorded exactly 1 InvalidOverflow error"
    );
}