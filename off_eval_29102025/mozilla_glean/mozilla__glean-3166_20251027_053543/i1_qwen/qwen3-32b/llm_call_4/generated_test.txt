#[test]
fn test_keyed_categorical_counter_regression() {
    // Test valid usage.
    let metric = glean_metrics::test_dual_labeled::dynamic_dynamic.get("valid_key", "valid_category");
    metric.add(1);
    assert_eq!(Some(1), metric.test_get_value(None));
    assert_eq!(0, metric.test_get_num_recorded_errors(ErrorType::InvalidLabel));

    // Test invalid key and valid category.
    let invalid_metric = glean_metrics::test_dual_labeled::dynamic_dynamic.get("invalid_key", "valid_category");
    invalid_metric.add(1);

    // Confirm "__other__" accumulates invalid keys.
    let other_metric = glean_metrics::test_dual_labeled::dynamic_dynamic.get("__other__", "valid_category");
    assert_eq!(Some(1), other_metric.test_get_value(None));

    // Check error count after invalid key usage.
    let metric_after_invalid_key = glean_metrics::test_dual_labeled::dynamic_dynamic.get("valid_key", "valid_category");
    assert_eq!(1, metric_after_invalid_key.test_get_num_recorded_errors(ErrorType::InvalidLabel));

    // Test invalid category and valid key.
    let invalid_category_metric = glean_metrics::test_dual_labeled::dynamic_dynamic.get("valid_key", "invalid_category");
    invalid_category_metric.add(1);

    // Confirm "__other__" accumulates invalid category.
    let other_category_metric = glean_metrics::test_dual_labeled::dynamic_dynamic.get("valid_key", "__other__");
    assert_eq!(Some(1), other_category_metric.test_get_value(None));

    // Check error count after invalid category usage.
    let metric_after_invalid_category = glean_metrics::test_dual_labeled::dynamic_dynamic.get("valid_key", "valid_category");
    assert_eq!(1, metric_after_invalid_category.test_get_num_recorded_errors(ErrorType::InvalidLabel));
}