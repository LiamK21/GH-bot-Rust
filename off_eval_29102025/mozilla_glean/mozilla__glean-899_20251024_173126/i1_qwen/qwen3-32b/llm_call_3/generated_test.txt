#[test]
fn test_pretty_body() {
    let tempdir = TempDir::new("glean_upload_test").unwrap();
    let upload_manager = PingUploadManager::new(tempdir.path());

    let json = r#"{"a":true,"b":0}"#;
    let mut encoder = GzEncoder::new(Vec::new(), Compression::default());
    encoder.write_all(json.as_bytes()).unwrap();
    let compressed = encoder.finish().unwrap();

    upload_manager.enqueue_ping("test-doc".to_string(), "test-path", &compressed);

    while upload_manager.get_upload_task(false) == PingUploadTask::Wait {
        std::thread::sleep(std::time::Duration::from_millis(10));
    }

    let upload_task = upload_manager.get_upload_task(false);
    let request = match upload_task {
        PingUploadTask::Upload(req) => req,
        _ => panic!("Expected Upload task"),
    };

    let pretty = request.pretty_body().unwrap();
    let expected = r#"
    {
      "a": true,
      "b": 0
    }"#;
    assert_eq!(pretty, expected.trim());
}