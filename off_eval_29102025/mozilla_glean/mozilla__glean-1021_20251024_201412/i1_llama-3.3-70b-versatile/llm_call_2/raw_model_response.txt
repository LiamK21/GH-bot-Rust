<Filename>glean-core/src/upload/mod.rs</Filename>
<imports>
use crate::PingUploadManager;
use crate::PingType;
use crate::tests::new_glean;
use std::thread;
use std::time::Duration;
use tempfile::tempdir;
use serde_json::json;
</imports>
<Rust>
#[test]
fn test_duplicates_are_not_enqueued() {
  let dir = tempdir().unwrap();
  let upload_manager = PingUploadManager::new(dir.path(), false);
  let doc_id = "684fa150-8dff-11ea-8faf-cb1ff3b11119";
  let path = format!("/submit/app_id/test-ping/1/{}", doc_id);
  let ping_type = PingType::new("test", true, /* send_if_empty */ true, vec![]);
  let mut glean = new_glean(None).0;
  glean.register_ping_type(&ping_type);
  upload_manager.enqueue_ping(doc_id, &path, json!({}), None);
  upload_manager.enqueue_ping(doc_id, &path, json!({}), None);
  while upload_manager.get_upload_task(false) == super::PingUploadTask::Wait {
    thread::sleep(Duration::from_millis(10));
  }
  let task = upload_manager.get_upload_task(false);
  assert_eq!(task, super::PingUploadTask::Done);
}
</Rust>