<Filename>glean-core/src/upload/mod.rs</Filename>
<imports>
use super::process_ping_upload_response;
use crate::PingUploadTask;
use crate::UploadResult;
use crate::tests::new_glean;
use crate::metrics::PingType;
use serde_json::json;
use std::thread;
use std::time::Duration;
use uuid::Uuid;
</imports>
<Rust>
#[test]
fn test_processes_correctly_client_error_upload_response() {
    let (mut glean, _) = new_glean(None);

    while glean.get_upload_task(false) == PingUploadTask::Wait {
        thread::sleep(Duration::from_millis(10));
    }

    let ping_type = PingType::new("test", true, true, vec![]);
    glean.register_ping_type(&ping_type);

    let doc_id = Uuid::new_v4().to_string();
    let path = format!("/submit/app_id/test-ping/1/{}", doc_id);
    glean.upload_manager.enqueue_ping(&doc_id, &path, json!({}), None);

    glean.upload_manager.process_ping_upload_response(&doc_id, UploadResult::HttpStatus(400), None);

    let req = match glean.get_upload_task(false) {
        PingUploadTask::Upload(req) => req,
        _ => panic!("Expected upload manager to return the next request!"),
    };
    assert_eq!(doc_id, req.document_id);
}
</Rust>