#[test]
fn test_requeues_after_client_error() {
    let dir = tempdir().unwrap();
    let upload_manager = PingUploadManager::new(dir.path(), false);

    let doc_id = Uuid::new_v4().to_string();
    let path = format!("/submit/APP_ID/PING_NAME/1/{}", doc_id);
    let body = serde_json::json!({});

    let mut queue = upload_manager.queue.write().unwrap();
    queue.push_back(PingRequest::new(&doc_id, &path, body, None));

    upload_manager.process_ping_upload_response(&doc_id, UploadResult::HttpStatus(400), None);

    // Wait for the directory processing to complete
    while upload_manager.get_upload_task(false) == PingUploadTask::Wait {
        std::thread::sleep(Duration::from_millis(10));
    }

    match upload_manager.get_upload_task(false) {
        PingUploadTask::Upload(_) => {}
        got => panic!("Expected requeued ping, got: {:?}", got),
    }
}