#[test]
fn test_glean_handle_client_active_calls_trigger_upload() {
    struct MockCallbacks {
        called: Arc<AtomicBool>,
    }

    impl MockCallbacks {
        fn new() -> Self {
            Self {
                called: Arc::new(AtomicBool::new(false)),
            }
        }
    }

    impl OnGleanEvents for MockCallbacks {
        fn on_initialize_finished(&self) {}
        fn trigger_upload(&self) {
            self.called.store(true, Ordering::SeqCst);
        }
        fn start_metric_ping_scheduler(&self) {}
    }

    let client_info = ClientInfoMetrics {
        app_build: "test-build".to_string(),
        app_display_version: "1.0".to_string(),
        architecture: "x86_64".to_string(),
        os_version: "Linux 5.0".to_string(),
        channel: None,
        android_sdk_version: None,
        device_manufacturer: None,
        device_model: None,
        locale: None,
    };

    let callbacks = MockCallbacks::new();
    let config = InternalConfiguration {
        upload_enabled: true,
        ..Default::default()
    };

    assert!(glean_initialize(config, client_info, Box::new(callbacks)));
    block_on_dispatcher();
    glean_handle_client_active();
    assert!(callbacks.called.load(Ordering::SeqCst));
}