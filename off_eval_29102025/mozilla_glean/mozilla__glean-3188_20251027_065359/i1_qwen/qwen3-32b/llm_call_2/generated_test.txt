#[test]
fn test_uploader_capabilities_instrumented() {
    let mut ping = Ping {
        name: "test_ping",
        url_path: "/test",
        content: HashMap::new(),
        headers: HashMap::new(),
        includes_info_sections: true,
        schedules_pings: Vec::new(),
        ..Default::default()
    };
    ping.content.insert("uploader_capabilities".to_string(), json!(vec!["test_cap", "another_cap"]));
    let send_if_empty = true;

    let ping_maker = PingMaker::new();
    let mut metrics_data = None;
    let mut events_data = None;

    ping_maker.build_ping_data(&ping, &mut metrics_data, &mut events_data);

    let metrics_obj = metrics_data.unwrap().as_object().unwrap();
    let string_list = metrics_obj
        .get("string_list")
        .unwrap()
        .as_object()
        .unwrap();
    let caps = string_list
        .get("glean.ping.uploader_capabilities")
        .unwrap()
        .as_array()
        .unwrap();

    assert_eq!(caps.len(), 2, "Uploader capabilities list should contain 2 items");
    assert!(caps.contains(&json!("test_cap")), "Uploader capabilities missing expected value");
    assert!(caps.contains(&json!("another_cap")), "Uploader capabilities missing expected value");
}