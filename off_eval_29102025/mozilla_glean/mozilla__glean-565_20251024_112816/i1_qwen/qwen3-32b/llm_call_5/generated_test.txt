#[test]
fn test_load_ping_lifetime_data_after_restart() {
    // Create a temporary directory and database with delay_ping_lifetime_io enabled.
    let dir = tempdir().unwrap();
    let db_path = dir.path().to_path_lossy().into_owned();

    // First instance: record a metric and persist to disk
    {
        let db = Database::new(&db_path, true).unwrap();

        let storage_name = "storage";
        let metric_id = "metric";
        let metric = Metric::String("test_value".to_string());

        db.record_per_lifetime(
            Lifetime::Ping,
            storage_name,
            metric_id,
            &metric,
        ).unwrap();

        // Persist the in-memory data to disk
        db.persist_ping_lifetime_data().unwrap();
    }

    // Second instance: verify data is loaded back into memory
    {
        let db = Database::new(&db_path, true).unwrap();

        let key = format!("{}#{}", "storage", "metric");
        let ping_data = db.ping_lifetime_data.as_ref().unwrap().read().unwrap();
        assert!(ping_data.get(&key).is_some(), "Metric should be loaded from disk");
    }
}