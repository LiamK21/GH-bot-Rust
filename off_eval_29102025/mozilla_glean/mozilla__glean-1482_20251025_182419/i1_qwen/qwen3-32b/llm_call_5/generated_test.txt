#[test]
fn test_coverage_recorded_after_test_has_value_called() {
    let coverage_file = env::temp_dir().join("event_coverage_test.out");
    env::set_var("GLEAN_TEST_COVERAGE", coverage_file.clone());

    let meta = CommonMetricData {
        category: "event_category".into(),
        name: "event_metric".into(),
        send_in_pings: Vec::new(),
        lifetime: Lifetime::Application,
        disabled: false,
        dynamic_label: None,
    };

    let metric = EventMetric::new(meta.clone(), None);

    let empty_db = crate::database::Database::new(":memory:", false)
        .expect("Should create in-memory database");
    let storage_manager = crate::storage::StorageManager::default();
    storage_manager.register_database("test_ping", empty_db);

    // Create a Glean instance with default configuration to access the storage
    let glean = crate::Glean::with_configuration(crate::Configuration {
        data_path: "/tmp".into(),
        ..Default::default()
    })
    .expect("Should create Glean instance");

    metric.test_has_value(&glean, "test_ping");

    let content = fs::read_to_string(&coverage_file).unwrap();
    assert!(content.contains("event_category.event_metric"));
}