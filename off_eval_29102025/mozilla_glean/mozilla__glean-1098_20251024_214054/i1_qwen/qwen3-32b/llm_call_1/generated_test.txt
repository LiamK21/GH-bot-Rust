#[test]
fn test_ping_over_1mb_rejected() {
    let (glean, _) = new_glean(None);
    let dir = TempDir::new().unwrap();
    let mut upload_manager = PingUploadManager::new(dir.path(), "Rust", false);

    // Wait for directory processing to complete
    while upload_manager.get_upload_task(&glean, false) == PingUploadTask::Wait {
        thread::sleep(Duration::from_millis(10));
    }

    // Create a ping file with body size just over 1MB (1024*1024 + 1 bytes)
    let doc_id = "over_1mb";
    let path = format!("/submit/app_id/test/1/{}", doc_id);
    let body_size = 1024 * 1024 + 1;
    let mut file = File::create(dir.path().join(doc_id)).unwrap();
    writeln!(file, "x").unwrap(); // Write a minimal body
    // Simulate the directory manager having processed this file
    upload_manager.pending_pings.write().unwrap().push((
        doc_id.to_string(),
        path,
        "x".repeat(body_size),
        None
    ));

    // Process pending pings
    while upload_manager.get_upload_task(&glean, false) == PingUploadTask::Wait {
        thread::sleep(Duration::from_millis(10));
    }

    // Verify ping was not enqueued
    match upload_manager.get_upload_task(&glean, false) {
        PingUploadTask::Done => {}
        _ => panic!("Unexpected upload task"),
    }

    // Verify discard metric was recorded
    let discarded_metric = upload_manager.upload_metrics.discarded_exceeding_pings_size;
    let samples = discarded_metric.test_get_values(&glean, None).unwrap();
    assert_eq!(samples.len(), 1);
    assert_eq!(samples[0], 1024); // 1MB+1 = 1024.00097... KB
}