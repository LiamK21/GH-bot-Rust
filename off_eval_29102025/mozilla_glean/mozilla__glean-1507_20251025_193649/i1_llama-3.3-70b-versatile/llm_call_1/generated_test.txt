#[test]
fn test_custom_ping_submission_callback() {
  let _lock = std::sync::Mutex::new(());
  let _lock = _lock.lock().unwrap();
  let (s, r) = bounded::<String>(1);
  let dir = tempdir().unwrap();
  let tmpname = dir.path().to_path_buf();
  let cfg = Configuration {
    data_path: tmpname,
    application_id: "test".into(),
    upload_enabled: true,
    max_events: None,
    delay_ping_lifetime_io: false,
    channel: Some("testing".into()),
    server_endpoint: Some("invalid-test-host".into()),
    uploader: Some(Box::new(struct FakeUploader { sender: s })),
  };
  let _t = new_glean(Some(cfg), true);
  let sample_ping = PingType::new("custom1", true, true, vec![]);
  let metric = CounterMetric::new(CommonMetricData {
    name: "counter_metric".into(),
    category: "test".into(),
    send_in_pings: vec!["custom1".into()],
    lifetime: Lifetime::Application,
    disabled: false,
    dynamic_label: None,
  });
  block_on_dispatcher();
  metric.add(1);
  let called = Arc::new(Mutex::new(false));
  let called_clone = Arc::clone(&called);
  sample_ping.test_before_next_submit(move |_| {
    *called_clone.lock().unwrap() = true;
  });
  sample_ping.submit(None);
  assert!(*called.lock().unwrap());
}