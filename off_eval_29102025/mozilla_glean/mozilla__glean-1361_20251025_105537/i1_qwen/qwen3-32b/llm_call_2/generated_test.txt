#[test]
fn test_invalid_extra_key_records_error() {
    let _lock = CommonTest::lock_test();
    let _t = new_glean(None, true);

    #[derive(Debug, Clone, Copy, Hash, Eq, PartialEq)]
    enum TestExtra {
        ValidKey,
    }

    impl ExtraKeys for TestExtra {
        const ALLOWED_KEYS: &'static [&'static str] = &["valid_key"];
        fn index(self) -> i32 { self as i32 }
    }

    let metric: EventMetric<TestExtra> = EventMetric::new(crate::CommonMetricData {
        name: "event".into(),
        category: "test".into(),
        send_in_pings: vec!["test1".into()],
        ..Default::default()
    });

    let mut invalid_map = HashMap::new();
    invalid_map.insert("other_key", "value".into()); // Not in allowed_keys
    metric.record(invalid_map);

    let errors = metric.test_get_num_recorded_errors(crate::ErrorType::InvalidExtraKey, None);
    assert_eq!(1, errors);
}