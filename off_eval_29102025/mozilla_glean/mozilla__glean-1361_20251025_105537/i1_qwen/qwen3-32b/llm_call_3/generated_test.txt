#[test]
fn test_invalid_extra_key_records_error() {
    let _lock = lock_test();
    let _t = new_glean(None, true);

    #[derive(Debug, Clone, Copy, Hash, Eq, PartialEq)]
    enum TestExtra {
        ValidKey,
        InvalidKey,
    }

    impl ExtraKeys for TestExtra {
        const ALLOWED_KEYS: &'static [&'static str] = &["valid_key"];
        fn index(self) -> i32 { self as i32 }
    }

    let metric: EventMetric<TestExtra> = EventMetric::new(glean_core::CommonMetricData {
        name: "event".into(),
        category: "test".into(),
        send_in_pings: vec!["test1".into()],
        ..Default::default()
    });

    let mut invalid_map = std::collections::HashMap::new();
    invalid_map.insert(TestExtra::InvalidKey, "value".into());

    metric.record(invalid_map);

    let errors = metric.test_get_num_recorded_errors(ErrorType::InvalidExtraKey, None);
    assert_eq!(1, errors);
}