<Filename>glean-core/src/upload/mod.rs</Filename>
<imports>
use super::new_glean;
use super::PingType;
use super::RecoverableFailure;
use super::PingUploadTask;
</imports>
<Rust>
#[test]
fn test_recoverable_failure_limit() {
  let (mut glean, _) = new_glean(None);
  let ping_type = PingType::new("test", true, /* send_if_empty */ true, vec![]);
  glean.register_ping_type(&ping_type);
  for _ in 0..5 {
    glean.submit_ping(&ping_type, None).unwrap();
  }
  for _ in 0..super::MAX_RECOVERABLE_FAILURES_PER_UPLOADING_WINDOW {
    match glean.get_upload_task() {
      PingUploadTask::Upload(req) => {
        glean.process_ping_upload_response(&req.document_id, RecoverableFailure)
      }
      _ => panic!("Expected upload manager to return the next request!"),
    }
  }
  assert_eq!(glean.get_upload_task(), PingUploadTask::Done);
  thread::sleep(Duration::from_millis(10));
  assert_ne!(glean.get_upload_task(), PingUploadTask::Done);
}
</Rust>