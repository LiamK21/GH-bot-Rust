<Filename>glean-core/src/lib_unit_tests.rs</Filename>
<imports>
use std::fs;
use std::os::unix::fs::PermissionsExt;
use crate::tests::new_glean;
</imports>
<Rust>
#[test]
fn test_io_error_reporting() {
    let _ = env_logger::builder().is_test(true).try_init();

    let (glean, _data_dir) = new_glean(None);
    let pending_pings_dir = glean.get_data_path().join(crate::PENDING_PINGS_DIRECTORY);
    fs::create_dir_all(&pending_pings_dir).unwrap();
    let attr = fs::metadata(&pending_pings_dir).unwrap();
    let original_permissions = attr.permissions();

    let mut permissions = original_permissions.clone();
    permissions.set_mode(0o555);
    fs::set_permissions(&pending_pings_dir, permissions).unwrap();

    let submitted = glean.internal_pings.metrics.submit(&glean, None);
    assert!(submitted.is_err());

    let metric = &glean.core_metrics.io_errors;
    assert_eq!(
        1,
        metric.test_get_value(&glean, "metrics").unwrap(),
        "Should have recorded an IO error"
    );

    fs::set_permissions(&pending_pings_dir, original_permissions).unwrap();

    let submitted = glean.internal_pings.metrics.submit(&glean, None);
    assert!(submitted.is_ok());
}
</Rust>