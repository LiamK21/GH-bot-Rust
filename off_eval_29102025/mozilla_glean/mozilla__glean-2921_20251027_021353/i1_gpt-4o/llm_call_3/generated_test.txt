#[test]
fn test_set_string_with_null_values() {
    let _lock = lock_test();
    let _t = new_glean(None, true);

    #[derive(
        Debug, Hash, Eq, PartialEq, traits::__serde::Deserialize, traits::__serde::Serialize,
    )]
    #[serde(crate = "traits::__serde")]
    #[serde(deny_unknown_fields)]
    struct TestObject {
        #[serde(skip_serializing_if = "Option::is_none")]
        field1: Option<String>,
        #[serde(
            skip_serializing_if = "Vec::is_empty",
            default = "Vec::new",
            deserialize_with = "traits::__serde_helper::vec_null"
        )]
        field2: Vec<String>,
    }

    let metric: ObjectMetric<TestObject> = ObjectMetric::new(CommonMetricData {
        name: "object".into(),
        category: "test".into(),
        send_in_pings: vec!["test1".into()],
        ..Default::default()
    });

    let input_json = json!({
        "field1": "value",
        "field2": null,
    })
    .to_string();
    metric.set_string(input_json);

    let data = metric.test_get_value(None).expect("no object recorded");
    let expected = json!({
        "field1": "value"
    });
    assert_eq!(expected, data);
    assert_eq!(
        0,
        metric.test_get_num_recorded_errors(ErrorType::InvalidValue)
    );
}